<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynka — لوحة الإدارة</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTn8s4M/b8A+e+I6lP/h1+iR4/R0+cW2J7/JbXj8DqXg4Kj9C0+n2w5A3Xg/yQ3q/mQ/iA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg: #f7f9fc;
      --ink: #0b1220;
      --muted: #6b7280;
      --brand: #4f46e5;
      --brand-hover: #3f36d5;
      --ok: #10b981;
      --ok-hover: #0d9d6e;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --surface: #ffffff;
      --line: #e5e7eb;
      --tabbar: #1e293b; /* Darker tone for tabs bar */
      --tab-bg: #334155; /* Slightly lighter for inactive tabs */
      --tab-active: #ffffff;
      --soft: #eef4ff;
      --soft-green: #ecfff2;
      --soft-blue: #f3f7ff;
      --shadow-light: rgba(0, 0, 0, 0.08);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-brand: rgba(79, 70, 229, 0.2);
    }

    /* Base styles */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      font-size: 15px;
      line-height: 1.7;
      direction: rtl; /* Ensure RTL for the whole document */
      text-align: right; /* Align text to the right by default */
    }
    .wrap {
      max-width: 1200px;
      margin: auto;
      padding: 15px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin: 8px 0 18px;
    }
    .title {
      font-family: "Poppins", "Cairo", sans-serif;
      font-weight: 800;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--ink);
    }
    .title b {
      color: var(--brand);
    }
    .title i {
      color: var(--brand);
      font-size: 24px;
    }
    .user-pill {
      padding: 9px 15px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--brand), #06b6d4);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px var(--shadow-brand);
    }
    .user-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px var(--shadow-brand);
    }

    /* Tabs (Chrome-like style: dark bar, active tab white, others dark) */
    .tabs-bar {
      background: var(--tabbar);
      border-radius: 16px;
      padding: 8px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      box-shadow: 0 8px 24px var(--shadow-medium);
      white-space: nowrap; /* Prevent tabs from wrapping */
    }
    .tab {
      appearance: none;
      border: 0;
      cursor: pointer;
      font-family: "Cairo", sans-serif;
      font-weight: 700;
      color: #cbd5e1; /* Lighter text for inactive tabs */
      background: var(--tab-bg);
      padding: 12px 18px;
      border-radius: 14px;
      flex: 0 0 auto;
      transition: transform 0.15s ease, background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
    }
    .tab i {
      font-size: 18px;
      color: #94a3b8; /* Icon color for inactive tabs */
      transition: color 0.2s ease;
    }
    .tab:hover {
      transform: translateY(-2px);
      background: #475569; /* Slightly lighter on hover */
      color: #f8fafc;
    }
    .tab.active {
      background: var(--tab-active);
      color: var(--ink);
      box-shadow: inset 0 0 0 3px #e0e7ff; /* Brand accent on active */
      transform: translateY(-1px);
    }
    .tab.active i {
      color: var(--brand); /* Brand color for active icon */
    }

    section {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      margin-top: 18px;
      box-shadow: 0 4px 12px var(--shadow-light);
    }
    .hide {
      display: none !important;
    }

    .grid {
      display: grid;
      gap: 15px;
    }
    .two {
      grid-template-columns: 1fr 1fr;
    }
    .three {
      grid-template-columns: 1fr 1fr 1fr;
    }
    @media (max-width: 900px) {
      .two, .three {
        grid-template-columns: 1fr;
      }
      .title {
        font-size: 20px;
      }
      .user-pill {
        font-size: 13px;
        padding: 8px 12px;
      }
      .tab {
        padding: 10px 14px;
        font-size: 14px;
      }
      .tab i {
        font-size: 16px;
      }
      section {
        padding: 15px;
      }
    }
    @media (max-width: 500px) {
      .topbar {
        flex-direction: column;
        align-items: flex-end;
      }
      .title {
        align-self: flex-start;
      }
      .tabs-bar {
        border-radius: 12px;
        padding: 6px;
      }
      .tab {
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 10px;
      }
      .tab i {
        font-size: 14px;
      }
    }


    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      font-size: 15px;
      font-family: "Cairo", sans-serif;
      color: var(--ink);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--soft);
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    input::placeholder, textarea::placeholder {
      color: var(--muted);
      opacity: 0.7;
    }

    .btn {
      padding: 12px 18px;
      border: 0;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn i {
      font-size: 16px;
    }
    .brand {
      background: var(--brand);
      color: #fff;
    }
    .brand:hover {
      background: var(--brand-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px var(--shadow-brand);
    }
    .ok {
      background: var(--ok);
      color: #fff;
    }
    .ok:hover {
      background: var(--ok-hover);
      transform: translateY(-1px);
    }
    .red {
      background: var(--danger);
      color: #fff;
    }
    .red:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }
    .ghost {
      background: #eef2ff;
      color: var(--brand);
      border: 1px solid var(--soft);
    }
    .ghost:hover {
      background: #e0e7ff;
      transform: translateY(-1px);
      color: var(--brand-hover);
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    .label {
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 5px;
      display: block;
    }

    /* Cards/Lists */
    .card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .list > .item {
      background: var(--soft);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      transition: all 0.2s ease;
    }
    .list > .item:last-child {
      margin-bottom: 0;
    }
    .list > .item.item--done {
      background: var(--soft-green);
      border-color: #d1fae5;
    }
    .list > .item.item--low {
      background: #fff0f0;
      border-color: #fecaca;
    }
    .muted {
      color: var(--muted);
    }

    /* Products */
    .prod-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .prod-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .prod-head h3 {
      margin: 0;
      font-size: 18px;
    }
    .dist-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: center;
      background: #f8fafc;
      padding: 8px;
      border-radius: 8px;
    }
    @media (max-width: 600px) {
      .dist-row {
        grid-template-columns: 1fr;
      }
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
      margin-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      min-width: 700px; /* Ensure table is scrollable if content is too wide */
    }
    thead {
      background: #f8fafc;
      border-radius: 12px;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--line);
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
    }
    th:first-child, td:first-child { text-align: right; padding-right: 20px; }
    th:last-child, td:last-child { text-align: left; padding-left: 20px; }
    tbody tr:last-child td { border-bottom: none; }
    table th {
      font-weight: 700;
      color: var(--ink);
    }

    /* Panel background colors */
    [data-panel="tasks"] { background: #eaf2ff; }
    [data-panel="products"] { background: #edf7ff; }
    [data-panel="calc"] { background: #eefcf6; }
    [data-panel="orders"] { background: #fff7ed; }
    [data-panel="finance"] { background: #f7f0ff; }
    [data-panel="clients"] { background: #f0fbff; }
    [data-panel="inventory"] { background: #fff0f0; }
    [data-panel] section { background: #fff; }

    /* Toast */
    .toast {
      position: fixed;
      inset-inline: 0;
      top: 20px;
      margin: auto;
      max-width: fit-content;
      background: #111827;
      color: #fff;
      padding: 12px 18px;
      border-radius: 12px;
      transform: translateY(-40px);
      opacity: 0;
      pointer-events: none;
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Springy animation */
      z-index: 9999;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .toast i {
      color: #38bdf8;
      font-size: 20px;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Error Message Style */
    .error-message {
      color: var(--danger);
      font-weight: 600;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .error-message i {
      font-size: 16px;
    }
    /* Loading Indicator */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-inline-start: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title"><i class="fas fa-cubes"></i> لوحة الإدارة — <b>Lynka</b></div>
    <div class="user-pill" id="userpill" title="تسجيل الخروج / الدخول"><i class="fas fa-user-circle"></i> <span id="useremail">غير مسجل</span></div>
  </div>

  <div class="tabs-bar" id="tabs">
    <button class="tab" data-s="tasks"><i class="fas fa-tasks"></i> المهام</button>
    <button class="tab" data-s="products"><i class="fas fa-tags"></i> المنتجات</button>
    <button class="tab" data-s="calc"><i class="fas fa-calculator"></i> الحساب</button>
    <button class="tab" data-s="orders"><i class="fas fa-receipt"></i> الأوردرات</button>
    <button class="tab" data-s="finance"><i class="fas fa-chart-line"></i> مصروفات وأرباح</button>
    <button class="tab" data-s="clients"><i class="fas fa-users"></i> العملاء</button>
    <button class="tab" data-s="inventory"><i class="fas fa-boxes"></i> المخزون</button>
    <button class="tab active" data-s="auth"><i class="fas fa-lock"></i> الدخول</button>
  </div>

  <div data-panel="auth">
    <section id="s-auth">
      <div class="card grid">
        <h3 style="margin:0 0 10px; font-size: 20px; font-weight: 700;">تسجيل دخول Lynka</h3>
        <div class="grid two">
          <div>
            <label class="label">البريد الإلكتروني</label>
            <input id="inemail" type="email" placeholder="مثال: 1lynka.com أو 2lynka.com">
          </div>
          <div>
            <label class="label">كلمة المرور</label>
            <input id="inpass" type="password" placeholder="مثال: 87654321">
          </div>
        </div>
        <div class="row" style="justify-content: flex-end;">
          <button class="btn brand" id="btnlogin"><i class="fas fa-sign-in-alt"></i> دخول</button>
        </div>
        <div id="autherr" class="error-message hide"><i class="fas fa-exclamation-circle"></i> <span></span></div>
      </div>
    </section>
  </div>

  <div data-panel="tasks" class="hide">
    <section>
      <div class="grid two">
        <div class="card">
          <h3 style="margin:0 0 10px; font-size: 18px;">أضف مهمة جديدة</h3>
          <div class="grid">
            <textarea id="tasktext" placeholder="اكتب مهمة (يسمح بنص طويل)…"></textarea>
            <input id="tasktag" placeholder="التصنيف (اختياري) مثل: #مبيعات">
            <button class="btn brand" id="addtask"><i class="fas fa-plus-circle"></i> إضافة مهمة</button>
          </div>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0; font-size: 18px;">المهام المُنجزة</h3>
            <div class="muted">عدد: <span id="donecount" style="font-weight: 700;">0</span></div>
          </div>
          <div class="list" id="donelist" style="margin-top: 15px;"></div>
        </div>
      </div>
      <div class="card" style="margin-top:15px">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0; font-size: 18px;">المهام النشطة</h3>
          <div class="muted">عدد: <span id="activecount" style="font-weight: 700;">0</span></div>
        </div>
        <div class="list" id="taskslist" style="margin-top: 15px;"></div>
      </div>
    </section>
  </div>

  <div data-panel="products" class="hide">
    <section>
      <div class="card">
        <h3 style="margin:0 0 10px; font-size: 18px;">إضافة منتج جديد</h3>
        <div class="grid three">
          <div><label class="label">اسم المنتج</label><input id="pname" placeholder="مثال: تيشيرت قطن"></div>
          <div><label class="label">سعر المصنع</label><input id="pfactory" type="number" step="0.01" placeholder="مثال: 50.00"></div>
          <div><label class="label">الكمية</label><input id="pqty" type="number" step="1" placeholder="مثال: 100"></div>
        </div>
        <div class="grid two" style="margin-top:15px">
          <div><label class="label">اسم الموزّع (اختياري)</label><input id="pdistname" placeholder="مثال: موزع ABC"></div>
          <div><label class="label">سعر الموزّع (اختياري)</label><input id="pdistprice" type="number" step="0.01" placeholder="مثال: 75.00"></div>
        </div>
        <button class="btn brand" style="margin-top:15px" id="addproduct"><i class="fas fa-box-open"></i> إضافة المنتج</button>
      </div>
      <div id="productslist" class="grid two" style="margin-top:15px"></div>
    </section>
  </div>

  <div data-panel="calc" class="hide">
    <section>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0; font-size: 18px;">الحساب حسب الموزّع</h3>
          <div class="row">
            <label class="muted" style="font-weight: 600;">اختر الموزّع:</label>
            <select id="distselect" style="width: auto; min-width: 150px;"></select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>المنتج</th><th>سعر المصنع</th><th>الكمية</th>
              <th>سعر الموزّع</th><th>إجمالي المصنع</th><th>إجمالي الموزّع</th>
            </tr></thead>
            <tbody id="calctable"></tbody>
          </table>
        </div>
        <div class="row" style="justify-content:center;margin-top:20px;gap:25px;font-weight:800; font-size: 16px;">
          <div>إجمالي المصنع: <span id="totfactory" class="text-brand">0</span></div>
          <div>إجمالي الموزّع: <span id="totdist" class="text-ok">0</span></div>
          <div>الفرق (الربح): <span id="totdiff" class="text-danger">0</span></div>
        </div>
      </div>
    </section>
  </div>

  <div data-panel="orders" class="hide">
    <section>
      <div class="card">
        <h3 style="margin:0 0 10px; font-size: 18px;">إضافة أوردر جديد</h3>
        <div class="grid two">
          <div><label class="label">اسم العميل</label><input id="oclient" placeholder="مثال: أحمد محمد"></div>
          <div><label class="label">قيمة الأوردر</label><input id="oamount" type="number" step="0.01" placeholder="مثال: 150.00"></div>
        </div>
        <button class="btn brand" style="margin-top:15px" id="addorder"><i class="fas fa-shopping-cart"></i> إضافة أوردر</button>
      </div>
      <div class="card" style="margin-top:15px">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0; font-size: 18px;">قائمة الأوردرات</h3>
          <div><b>الإجمالي: </b><span id="sumorders" style="font-weight: 700;">0</span></div>
        </div>
        <div id="orderslist" class="list" style="margin-top:15px"></div>
      </div>
    </section>
  </div>

  <div data-panel="finance" class="hide">
    <section>
      <div class="grid two">
        <div class="card">
          <h3 style="margin:0 0 10px; font-size: 18px;">المصروفات</h3>
          <div class="grid two">
            <div><label class="label">وصف المصروف (اختياري)</label><input id="exdesc" placeholder="مثال: ايجار المتجر"></div>
            <div><label class="label">المبلغ</label><input id="examount" type="number" step="0.01" placeholder="مثال: 200.00"></div>
          </div>
          <button class="btn red" style="margin-top:15px" id="addexpense"><i class="fas fa-minus-circle"></i> إضافة مصروف</button>
          <div id="explist" class="list" style="margin-top:15px"></div>
          <div class="card" style="margin-top:15px; background: #fef2f2; border-color: #fca5a5;"><b>إجمالي المصروفات: </b><span id="sumexp" style="color: var(--danger); font-weight: 700;">0</span></div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 10px; font-size: 18px;">الأرباح</h3>
          <div class="grid two">
            <div><label class="label">وصف الربح (اختياري)</label><input id="prdesc" placeholder="مثال: أرباح شهرية"></div>
            <div><label class="label">المبلغ</label><input id="pramount" type="number" step="0.01" placeholder="مثال: 500.00"></div>
          </div>
          <button class="btn ok" style="margin-top:15px" id="addprofit"><i class="fas fa-plus-circle"></i> إضافة ربح</button>
          <div id="prolist" class="list" style="margin-top:15px"></div>
          <div class="card" style="margin-top:15px; background: #f0fdf4; border-color: #86efac;"><b>إجمالي الأرباح: </b><span id="sumpro" style="color: var(--ok); font-weight: 700;">0</span></div>
        </div>
      </div>
    </section>
  </div>

  <div data-panel="clients" class="hide">
    <section>
      <div class="card">
        <h3 style="margin:0 0 10px; font-size: 18px;">إضافة عميل جديد</h3>
        <div class="grid two">
          <div><label class="label">اسم العميل</label><input id="cname" placeholder="مثال: يوسف خالد"></div>
          <div><label class="label">هاتف العميل (اختياري)</label><input id="cphone" placeholder="مثال: 01012345678"></div>
        </div>
        <button class="btn brand" style="margin-top:15px" id="addclient"><i class="fas fa-user-plus"></i> إضافة عميل</button>
      </div>
      <div class="card" style="margin-top:15px">
        <h3 style="margin:0 0 10px; font-size: 18px;">قائمة العملاء</h3>
        <div id="clientslist" class="list" style="margin-top:15px"></div>
      </div>
    </section>
  </div>

  <div data-panel="inventory" class="hide">
    <section>
      <div class="card">
        <h3 style="margin:0 0 10px; font-size: 18px;">إضافة صنف للمخزون</h3>
        <div class="grid three">
          <div><label class="label">اسم الصنف</label><input id="iname" placeholder="مثال: هاتف ذكي"></div>
          <div><label class="label">الكمية الحالية</label><input id="iqty" type="number" step="1" placeholder="مثال: 50"></div>
          <div><label class="label">حد التنبيه (اختياري)</label><input id="imin" type="number" step="1" placeholder="مثال: 10"></div>
        </div>
        <button class="btn brand" style="margin-top:15px" id="addinv"><i class="fas fa-warehouse"></i> إضافة صنف</button>
      </div>
      <div class="card" style="margin-top:15px">
        <h3 style="margin:0 0 10px; font-size: 18px;">المخزون الحالي</h3>
        <div id="invlist" class="list" style="margin-top:15px"></div>
      </div>
    </section>
  </div>
</div>

<div id="welcometoast" class="toast"><i class="fas fa-hand-sparkles"></i> <span>مرحباً بعودتك، <b>[المستخدم]</b>!</span></div>
<div id="loading-spinner" class="loading-spinner hide"></div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "aizasycnm6-7boiclwaxueh8qz8a_ocicgpqtmu", // Replace with your actual API Key
    authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
    projectId: "lynka-to-do-list-eb2ac",
    storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
    messagingSenderId: "202285237255",
    appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* helpers */
  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const en = n => (Number(n || 0)).toLocaleString('en-US', {maximumFractionDigits: 2});
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;" }[m]));

  /* UI elements */
  const tabs = $$('#tabs .tab');
  const panels = $$('[data-panel]');
  const userPill = $('#userpill');
  const userEmail = $('#useremail');
  const authErr = $('#autherr');
  const authErrSpan = $('#autherr span');
  const btnLogin = $('#btnlogin');
  const welcomeToast = $('#welcometoast');
  const welcomeToastText = $('#welcometoast span');

  /* Loading state management */
  function showLoading(button, show) {
    if (show) {
      button.dataset.originalHtml = button.innerHTML;
      button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جاري التحميل...`;
      button.disabled = true;
      button.style.opacity = '0.8';
    } else {
      button.innerHTML = button.dataset.originalHtml;
      button.disabled = false;
      button.style.opacity = '1';
    }
  }

  /* Tabs functionality */
  function showTab(key) {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.s === key));
    panels.forEach(p => p.classList.toggle('hide', p.getAttribute('data-panel') !== key));
    sessionStorage.setItem('lynka_tab', key); // Save last active tab
  }
  tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.s)));
  // Default tab when not logged in or first load
  showTab(sessionStorage.getItem('lynka_tab') || 'auth');

  /* Toast once after first login */
  function welcomeOnce(email) {
    if (!localStorage.getItem('lynka_welcomed')) {
      welcomeToastText.innerHTML = `مرحباً بك في Lynka!`;
      welcomeToast.classList.add('show');
      setTimeout(() => welcomeToast.classList.remove('show'), 3000);
      localStorage.setItem('lynka_welcomed', '1');
    } else {
      welcomeToastText.innerHTML = `مرحباً بعودتك، <b>${email.split('@')[0]}</b>!`;
      welcomeToast.classList.add('show');
      setTimeout(() => welcomeToast.classList.remove('show'), 3000);
    }
  }

  /* Auth UI */
  btnLogin?.addEventListener('click', async () => {
    const email = $('#inemail').value.trim();
    const pass  = $('#inpass').value.trim();
    authErr.classList.add('hide'); // Hide previous errors
    showLoading(btnLogin, true); // Show loading spinner

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      $('#inemail').value = '';
      $('#inpass').value = '';
    } catch (e) {
      authErr.classList.remove('hide');
      let errorMessage = 'حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.';
      if (e.code === 'auth/invalid-email' || e.code === 'auth/user-not-found') {
        errorMessage = 'البريد الإلكتروني غير صحيح أو المستخدم غير موجود.';
      } else if (e.code === 'auth/wrong-password') {
        errorMessage = 'كلمة المرور غير صحيحة.';
      } else if (e.code === 'auth/too-many-requests') {
        errorMessage = 'تم حظر الحساب مؤقتًا بسبب كثرة محاولات تسجيل الدخول الفاشلة. حاول لاحقًا.';
      }
      authErrSpan.textContent = errorMessage;
    } finally {
      showLoading(btnLogin, false); // Hide loading spinner
    }
  });

  userPill.addEventListener('click', async () => {
    if (auth.currentUser) {
      if (confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟')) {
        await signOut(auth);
      }
    } else {
      showTab('auth');
    }
  });

  /* Firestore Collections */
  const colTasks   = collection(db, 'lynka_tasks');
  const colProds   = collection(db, 'lynka_products');
  const colOrders  = collection(db, 'lynka_orders');
  const colExp     = collection(db, 'lynka_expenses');
  const colPro     = collection(db, 'lynka_profits');
  const colClients = collection(db, 'lynka_clients');
  const colInv     = collection(db, 'lynka_inventory');

  /* State for unsubscribers */
  let unsubs = [];
  function detachAll() {
    unsubs.forEach(u => { try { u() } catch {} });
    unsubs = [];
    // clear ui
    ['#taskslist', '#donelist', '#productslist', '#orderslist', '#explist', '#prolist', '#clientslist', '#invlist', '#calctable']
      .forEach(s => { const el = $(s); if (el) el.innerHTML = ''; });
    ['#activecount', '#donecount', '#sumorders', '#sumexp', '#sumpro', '#totfactory', '#totdist', '#totdiff']
      .forEach(s => { const el = $(s); if (el) el.textContent = '0'; });
    $('#distselect').innerHTML = '';
    allProducts = []; // Clear products data
  }

  /* Require auth guard for write ops */
  function requireAuth() { if (!auth.currentUser) { showTab('auth'); throw new Error('not-auth'); } }

  /* ===== init modules after login ===== */
  let allProducts = []; // Global variable to store products for calculation

  function initTasks() {
    $('#addtask').onclick = async () => {
      try {
        requireAuth();
        const text = $('#tasktext').value.trim();
        const tag  = $('#tasktag').value.trim() || null;
        if (!text) return;

        showLoading($('#addtask'), true);
        await addDoc(colTasks, {text, tag, done: false, createdAt: serverTimestamp()});
        $('#tasktext').value = ''; $('#tasktag').value = '';
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding task: ", e);
      } finally {
        showLoading($('#addtask'), false);
      }
    };
    function taskItem(id, d) {
      const it = document.createElement('div');
      it.className = 'item' + (d.done ? ' item--done' : '');
      it.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div style="flex:1">
            <div style="font-weight:700">${esc(d.text)}</div>
            <div class="muted" style="margin-top:4px; font-size: 13px;">${d.tag ? ('#' + esc(d.tag)) : '—'}</div>
          </div>
          <div class="row">
            <label class="row" style="cursor:pointer; gap: 5px;"><input type="checkbox" ${d.done ? 'checked' : ''} style="transform:scale(1.2); cursor:pointer;"><span>منجز</span></label>
            <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button>
          </div>
        </div>`;
      it.querySelector('input').addEventListener('change', async () => {
        try { requireAuth(); await updateDoc(doc(db, 'lynka_tasks', id), {done: !d.done}); } catch {}
      });
      it.querySelector('.btn.red').addEventListener('click', async () => {
        try { requireAuth(); await deleteDoc(doc(db, 'lynka_tasks', id)); } catch {}
      });
      return it;
    }
    const unsub = onSnapshot(query(colTasks, orderBy('createdAt', 'desc')), (snap) => {
      const active = $('#taskslist'), done = $('#donelist'); active.innerHTML = ''; done.innerHTML = '';
      let a = 0, dn = 0;
      snap.forEach(s => {
        const data = s.data(); const el = taskItem(s.id, data);
        if (data.done) { dn++; done.appendChild(el); } else { a++; active.appendChild(el); }
      });
      $('#activecount').textContent = a; $('#donecount').textContent = dn;
    });
    unsubs.push(unsub);
  }

  function initProducts() {
    $('#addproduct').onclick = async () => {
      try {
        requireAuth();
        const name    = $('#pname').value.trim();
        const factory = parseFloat(($('#pfactory').value || '').toString().replace(',', '.'));
        const qty     = parseInt($('#pqty').value || '0', 10);
        const dname   = $('#pdistname').value.trim();
        const dprice  = parseFloat(($('#pdistprice').value || '').toString().replace(',', '.'));
        if (!name || isNaN(factory) || !qty) {
          alert('يرجى إدخال اسم المنتج، سعر المصنع، والكمية.');
          return;
        }
        const distributors = {};
        if (dname && !isNaN(dprice)) distributors[dname] = dprice;

        showLoading($('#addproduct'), true);
        await addDoc(colProds, {name, factory, qty, distributors, createdAt: serverTimestamp()});
        ['#pname', '#pfactory', '#pqty', '#pdistname', '#pdistprice'].forEach(s => $(s).value = '');
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding product: ", e);
      } finally {
        showLoading($('#addproduct'), false);
      }
    };
    function productCard(id, d) {
      const card = document.createElement('div'); card.className = 'prod-card';
      card.innerHTML = `
        <div class="prod-head">
          <h3 style="font-weight:800">${esc(d.name)}</h3>
          <div class="row">
            <button class="btn ghost btn-sm" data-act="save"><i class="fas fa-save"></i> حفظ</button>
            <button class="btn red btn-sm" data-act="del"><i class="fas fa-trash-alt"></i> حذف</button>
          </div>
        </div>
        <div class="grid three">
          <div><label class="muted">سعر المصنع</label><input type="number" step="0.01" value="${d.factory ?? 0}" data-f="factory"></div>
          <div><label class="muted">الكمية</label><input type="number" step="1" value="${d.qty ?? 0}" data-f="qty"></div>
          <div><label class="muted">إضافة موزّع</label>
            <div class="row" style="flex-wrap: nowrap;">
              <input placeholder="اسم" data-add-name style="width: 100px;">
              <input type="number" step="0.01" placeholder="السعر" data-add-price style="width: 80px;">
              <button class="btn brand btn-sm" data-act="adddist"><i class="fas fa-user-plus"></i></button>
            </div>
          </div>
        </div>
        <div><label class="muted">الموزّعين</label><div class="list" data-dists style="margin-top: 5px;"></div></div>
      `;
      const dWrap = card.querySelector('[data-dists]'); dWrap.innerHTML = '';
      Object.entries(d.distributors || {}).forEach(([name, price]) => {
        const row = document.createElement('div'); row.className = 'dist-row';
        row.innerHTML = `
          <input value="${esc(name)}" data-dn>
          <input type="number" step="0.01" value="${price}" data-dp>
          <div class="row">
            <button class="btn ghost btn-sm" data-act="upd"><i class="fas fa-sync-alt"></i></button>
            <button class="btn red btn-sm" data-act="del"><i class="fas fa-times"></i></button>
          </div>`;
        row.querySelector('[data-act="upd"]').onclick = async () => {
          try {
            requireAuth();
            const newname = row.querySelector('[data-dn]').value.trim();
            const newprice = parseFloat((row.querySelector('[data-dp]').value || '').toString().replace(',', '.'));
            if (!newname || isNaN(newprice)) return;
            const map = {...(d.distributors || {})}; delete map[name]; map[newname] = newprice;
            await updateDoc(doc(db, 'lynka_products', id), {distributors: map});
          } catch {}
        };
        row.querySelector('[data-act="del"]').onclick = async () => {
          try {
            requireAuth();
            const map = {...(d.distributors || {})}; delete map[name];
            await updateDoc(doc(db, 'lynka_products', id), {distributors: map});
          } catch {}
        };
        dWrap.appendChild(row);
      });
      card.querySelector('[data-act="adddist"]').onclick = async () => {
        try {
          requireAuth();
          const n = card.querySelector('[data-add-name]').value.trim();
          const p = parseFloat((card.querySelector('[data-add-price]').value || '').toString().replace(',', '.'));
          if (!n || isNaN(p)) return;
          const map = {...(d.distributors || {})}; map[n] = p;
          await updateDoc(doc(db, 'lynka_products', id), {distributors: map});
          card.querySelector('[data-add-name]').value = ''; card.querySelector('[data-add-price]').value = '';
        } catch {}
      };
      card.querySelector('[data-act="save"]').onclick = async () => {
        try {
          requireAuth();
          const factory = parseFloat((card.querySelector('[data-f="factory"]').value || '').toString().replace(',', '.'));
          const qty = parseInt(card.querySelector('[data-f="qty"]').value || '0', 10);
          if (isNaN(factory) || isNaN(qty)) return;
          await updateDoc(doc(db, 'lynka_products', id), {factory, qty});
        } catch {}
      };
      card.querySelector('[data-act="del"]').onclick = async () => { try { requireAuth(); await deleteDoc(doc(db, 'lynka_products', id)); } catch {} };
      return card;
    }
    const unsub = onSnapshot(query(colProds, orderBy('createdAt', 'desc')), (snap) => {
      allProducts = []; const wrap = $('#productslist'); wrap.innerHTML = ''; const distSet = new Set();
      snap.forEach(s => {
        const data = s.data(); allProducts.push({id: s.id, ...data});
        Object.keys(data.distributors || {}).forEach(k => distSet.add(k));
        wrap.appendChild(productCard(s.id, data));
      });
      const sel = $('#distselect'); const cur = sel.value;
      sel.innerHTML = [...distSet].sort().map(n => `<option value="${n}">${n}</option>`).join('');
      if ([...distSet].includes(cur)) sel.value = cur;
      renderCalc();
    });
    unsubs.push(unsub);
  }

  function renderCalc() {
    const dist = $('#distselect').value;
    const body = $('#calctable'); body.innerHTML = '';
    let totF = 0, totD = 0;
    allProducts.forEach(p => {
      const price = (p.distributors || {})[dist];
      if (price == null) return;
      const f = (Number(p.factory) || 0) * (Number(p.qty) || 0);
      const d = (Number(price) || 0) * (Number(p.qty) || 0);
      totF += f; totD += d;
      body.insertAdjacentHTML('beforeend', `
        <tr><td>${esc(p.name)}</td><td>${en(p.factory)}</td><td>${en(p.qty)}</td>
        <td>${en(price)}</td><td>${en(f)}</td><td>${en(d)}</td></tr>`);
    });
    $('#totfactory').textContent = en(totF);
    $('#totdist').textContent = en(totD);
    $('#totdiff').textContent = en(totD - totF);
  }
  $('#distselect').addEventListener('change', renderCalc);

  function initOrders() {
    $('#addorder').onclick = async () => {
      try {
        requireAuth();
        const client = $('#oclient').value.trim();
        const amount = parseFloat(($('#oamount').value || '').toString().replace(',', '.'));
        if (!client || isNaN(amount)) {
          alert('يرجى إدخال اسم العميل وقيمة الأوردر.');
          return;
        }

        showLoading($('#addorder'), true);
        await addDoc(colOrders, {client, amount, createdAt: serverTimestamp()});
        $('#oclient').value = ''; $('#oamount').value = '';
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding order: ", e);
      } finally {
        showLoading($('#addorder'), false);
      }
    };
    const unsub = onSnapshot(query(colOrders, orderBy('createdAt', 'desc')), (snap) => {
      const l = $('#orderslist'); l.innerHTML = ''; let sum = 0;
      snap.forEach(s => {
        const d = s.data(); sum += Number(d.amount) || 0;
        const it = document.createElement('div'); it.className = 'item';
        it.innerHTML = `<div class="row" style="justify-content:space-between">
          <div style="font-weight:700">${esc(d.client)}</div>
          <div class="row"><div style="font-weight:800">${en(d.amount)}</div>
          <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button></div></div>`;
        it.querySelector('.btn.red').onclick = () => { try { requireAuth(); deleteDoc(doc(db, 'lynka_orders', s.id)); } catch {} };
        l.appendChild(it);
      });
      $('#sumorders').textContent = en(sum);
    });
    unsubs.push(unsub);
  }

  function initFinance() {
    $('#addexpense').onclick = async () => {
      try {
        requireAuth();
        const desc   = $('#exdesc').value.trim() || null;
        const amount = parseFloat(($('#examount').value || '').toString().replace(',', '.'));
        if (isNaN(amount)) {
          alert('يرجى إدخال مبلغ المصروف.');
          return;
        }

        showLoading($('#addexpense'), true);
        await addDoc(colExp, {desc, amount, createdAt: serverTimestamp()});
        $('#exdesc').value = ''; $('#examount').value = '';
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding expense: ", e);
      } finally {
        showLoading($('#addexpense'), false);
      }
    };
    $('#addprofit').onclick = async () => {
      try {
        requireAuth();
        const desc   = $('#prdesc').value.trim() || null;
        const amount = parseFloat(($('#pramount').value || '').toString().replace(',', '.'));
        if (isNaN(amount)) {
          alert('يرجى إدخال مبلغ الربح.');
          return;
        }

        showLoading($('#addprofit'), true);
        await addDoc(colPro, {desc, amount, createdAt: serverTimestamp()});
        $('#prdesc').value = ''; $('#pramount').value = '';
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding profit: ", e);
      } finally {
        showLoading($('#addprofit'), false);
      }
    };
    const un1 = onSnapshot(query(colExp, orderBy('createdAt', 'desc')), (snap) => {
      const l = $('#explist'); l.innerHTML = ''; let sum = 0;
      snap.forEach(s => {
        const d = s.data(); sum += Number(d.amount) || 0;
        const it = document.createElement('div'); it.className = 'item';
        it.innerHTML = `<div class="row" style="justify-content:space-between">
          <div>${d.desc ? esc(d.desc) : '<span class="muted">بدون وصف</span>'}</div>
          <div class="row"><div style="font-weight:800">${en(d.amount)}</div>
          <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button></div></div>`;
        it.querySelector('.btn.red').onclick = () => { try { requireAuth(); deleteDoc(doc(db, 'lynka_expenses', s.id)); } catch {} };
        l.appendChild(it);
      });
      $('#sumexp').textContent = en(sum);
    });
    const un2 = onSnapshot(query(colPro, orderBy('createdAt', 'desc')), (snap) => {
      const l = $('#prolist'); l.innerHTML = ''; let sum = 0;
      snap.forEach(s => {
        const d = s.data(); sum += Number(d.amount) || 0;
        const it = document.createElement('div'); it.className = 'item';
        it.innerHTML = `<div class="row" style="justify-content:space-between">
          <div>${d.desc ? esc(d.desc) : '<span class="muted">بدون وصف</span>'}</div>
          <div class="row"><div style="font-weight:800">${en(d.amount)}</div>
          <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button></div></div>`;
        it.querySelector('.btn.red').onclick = () => { try { requireAuth(); deleteDoc(doc(db, 'lynka_profits', s.id)); } catch {} };
        l.appendChild(it);
      });
      $('#sumpro').textContent = en(sum);
    });
    unsubs.push(un1, un2);
  }

  function initClients() {
    $('#addclient').onclick = async () => {
      try {
        requireAuth();
        const name  = $('#cname').value.trim();
        const phone = $('#cphone').value.trim() || null;
        if (!name) {
          alert('يرجى إدخال اسم العميل.');
          return;
        }

        showLoading($('#addclient'), true);
        await addDoc(colClients, {name, phone, createdAt: serverTimestamp()});
        $('#cname').value = ''; $('#cphone').value = '';
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding client: ", e);
      } finally {
        showLoading($('#addclient'), false);
      }
    };
    const unsub = onSnapshot(query(colClients, orderBy('createdAt', 'desc')), (snap) => {
      const l = $('#clientslist'); l.innerHTML = '';
      snap.forEach(s => {
        const d = s.data();
        const it = document.createElement('div'); it.className = 'item';
        it.innerHTML = `<div class="row" style="justify-content:space-between">
          <div style="font-weight:700">${esc(d.name)}</div>
          <div class="row"><div class="muted">${d.phone ? esc(d.phone) : '—'}</div>
          <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button></div></div>`;
        it.querySelector('.btn.red').onclick = () => { try { requireAuth(); deleteDoc(doc(db, 'lynka_clients', s.id)); } catch {} };
        l.appendChild(it);
      });
    });
    unsubs.push(unsub);
  }

  function initInventory() {
    $('#addinv').onclick = async () => {
      try {
        requireAuth();
        const name = $('#iname').value.trim();
        const qty  = parseInt($('#iqty').value || '0', 10);
        const min  = parseInt($('#imin').value || '0', 10);
        if (!name || isNaN(qty)) {
          alert('يرجى إدخال اسم الصنف والكمية.');
          return;
        }

        showLoading($('#addinv'), true);
        await addDoc(colInv, {name, qty, min:(isNaN(min)?0:min), createdAt: serverTimestamp()});
        ['#iname', '#iqty', '#imin'].forEach(s => $(s).value = '');
      } catch (e) {
        if (e.message !== 'not-auth') console.error("Error adding inventory item: ", e);
      } finally {
        showLoading($('#addinv'), false);
      }
    };
    const unsub = onSnapshot(query(colInv, orderBy('createdAt', 'desc')), (snap) => {
      const l = $('#invlist'); l.innerHTML = '';
      snap.forEach(s => {
        const d = s.data(); const low = (Number(d.qty) || 0) <= (Number(d.min) || 0);
        const it = document.createElement('div'); it.className = 'item' + (low ? ' item--low' : '');
        it.innerHTML = `<div class="row" style="justify-content:space-between">
          <div style="font-weight:700">${esc(d.name)} ${low ? '<span class="muted" style="color:var(--danger); font-size: 13px;"><i class="fas fa-exclamation-triangle"></i> مخزون منخفض</span>' : ''}</div>
          <div class="row">
            <div style="font-weight:800">${en(d.qty)}</div>
            <button class="btn ghost btn-sm" data-a="inc"><i class="fas fa-plus"></i></button>
            <button class="btn ghost btn-sm" data-a="dec"><i class="fas fa-minus"></i></button>
            <button class="btn red btn-sm"><i class="fas fa-trash-alt"></i></button>
          </div></div>`;
        it.querySelector('[data-a="inc"]').onclick = () => { try { requireAuth(); updateDoc(doc(db, 'lynka_inventory', s.id), {qty:(Number(d.qty)||0)+1}); } catch {} };
        it.querySelector('[data-a="dec"]').onclick = () => { try { requireAuth(); updateDoc(doc(db, 'lynka_inventory', s.id), {qty:Math.max(0,(Number(d.qty)||0)-1)}); } catch {} };
        it.querySelector('.btn.red').onclick = () => { try { requireAuth(); deleteDoc(doc(db, 'lynka_inventory', s.id)); } catch {} };
        l.appendChild(it);
      });
    });
    unsubs.push(unsub);
  }

  /* Auth State Observer */
  onAuthStateChanged(auth, u => {
    if (u) {
      userEmail.textContent = u.email || 'مستخدم';
      welcomeOnce(u.email || 'مستخدم');
      
      const lastTab = sessionStorage.getItem('lynka_tab');
      // If the last tab was 'auth', default to 'tasks', otherwise use the last tab.
      showTab(lastTab && lastTab !== 'auth' ? lastTab : 'tasks');

      // Attach all listeners after login
      detachAll(); // Ensure previous listeners are removed
      initTasks(); initProducts(); initOrders(); initFinance(); initClients(); initInventory();
    } else {
      userEmail.textContent = 'غير مسجل';
      detachAll(); // Detach listeners when logged out
      showTab('auth'); // Always show auth tab when logged out
      localStorage.removeItem('lynka_welcomed'); // Reset welcome message
    }
  });
</script>
</body>
</html>
