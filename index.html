<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynka â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±1Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f9fc; --ink:#0b1220; --muted:#667085;
      --brand:#2563eb; --ok:#10b981; --danger:#ef4444;
      --surface:#ffffff; --line:#e6e8ee;
      --tabbar:#0f172a; --tab-bg:#111827; --tab-active:#ffffff;
      --soft:#f2f6ff; --soft-green:#ecfff2; --soft-blue:#eef6ff;
      --soft-yellow:#fff7ed; --soft-purple:#f4f0ff; --soft-cyan:#edfaff; --soft-rose:#fff0f3;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto;
      font-size:15px;line-height:1.75;
    }
    .wrap{max-width:1100px;margin:auto;padding:14px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:6px 0 14px}
    .title{font-weight:800;font-size:20px}
    .user-pill{padding:8px 12px;border-radius:999px;background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;font-weight:700;cursor:pointer}

    /* Tabs (Ø´Ø±ÙŠØ· ØºØ§Ù…Ù‚ØŒ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø£Ø¨ÙŠØ¶ØŒ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ§Ø¨Ø§Øª ØºØ§Ù…Ù‚Ø©) */
    .tabs{
      background:var(--tabbar);border-radius:14px;padding:6px;display:flex;gap:6px;overflow-x:auto;
      box-shadow:0 8px 20px rgba(0,0,0,.18)
    }
    .tab{
      appearance:none;border:0;cursor:pointer;font-weight:800;
      color:#e5e7eb;background:var(--tab-bg);
      padding:10px 14px;border-radius:12px;flex:0 0 auto;
      transition:transform .15s ease, background .2s ease, color .2s ease;
      white-space:nowrap
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--tab-active);color:var(--ink);box-shadow:inset 0 0 0 2px #eef2ff}

    /* Panels Ø£Ù„ÙˆØ§Ù† Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„ÙƒÙ„ ØªØ¨ÙˆÙŠØ¨ */
    [data-panel]{padding:10px;border-radius:12px;margin-top:12px}
    [data-panel] section{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    [data-panel="auth"]{background:var(--soft)}
    [data-panel="tasks"]{background:var(--soft-blue)}
    [data-panel="products"]{background:var(--soft-cyan)}
    [data-panel="calc"]{background:var(--soft-green)}
    [data-panel="orders"]{background:var(--soft-yellow)}
    [data-panel="finance"]{background:var(--soft-purple)}
    [data-panel="clients"]{background:var(--soft)}
    [data-panel="inventory"]{background:var(--soft-rose)}
    .hide{display:none !important}

    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .three{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:768px){ .two,.three{grid-template-columns:1fr} .title{font-size:18px} }

    input,select,textarea{
      width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px
    }
    textarea{min-height:84px;resize:vertical}
    input::placeholder,textarea::placeholder{color:#9aa3b2}

    .btn{padding:10px 14px;border:0;border-radius:10px;font-weight:800;cursor:pointer;font-size:14px}
    .brand{background:var(--brand);color:#fff}
    .ok{background:var(--ok);color:#fff}
    .red{background:var(--danger);color:#fff}
    .ghost{background:#eef2ff;color:#1e293b}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-start}
    .muted{color:var(--muted)}
    .stat{font-weight:800}

    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .list .item{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    .item--done{background:var(--soft-green)}
    .prod-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px}
    .prod-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .dist-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ */
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    thead{background:#f8fafc}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center;font-size:14px;white-space:nowrap}

    /* Toast ØªØ±Ø­ÙŠØ¨ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© */
    .toast{
      position:fixed; inset-inline:0; top:14px; margin:auto; max-width:92%;
      background:#111827; color:#fff; padding:10px 12px; border-radius:12px;
      transform:translateY(-30px); opacity:0; pointer-events:none;
      transition:all .28s ease; z-index:9999; font-size:14px
    }
    .toast.show{transform:translateY(0); opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="topbar">
    <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” <b>Lynka</b></div>
    <div class="user-pill" id="userPill" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ / Ø§Ù„Ø¯Ø®ÙˆÙ„">
      <span id="userEmail">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs">
    <button class="tab" data-s="tasks">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button class="tab" data-s="products">ğŸ·ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button class="tab" data-s="calc">ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    <button class="tab" data-s="orders">ğŸ§¾ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
    <button class="tab" data-s="finance">ğŸ’¹ Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ£Ø±Ø¨Ø§Ø­</button>
    <button class="tab" data-s="clients">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    <button class="tab" data-s="inventory">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
    <button class="tab active" data-s="auth">ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Panels (ÙƒÙ„ Panel Ø¨Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ø®Ø§ØµØ©) -->
  <div data-panel="auth">
    <section id="s-auth">
      <div class="grid">
        <h3 style="margin:0 0 6px">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Lynka</h3>
        <div class="grid two">
          <div>
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input id="inEmail" type="email" placeholder="1@lynka.com Ø£Ùˆ 2@lynka.com">
          </div>
          <div>
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="inPass" type="password" placeholder="87654321">
          </div>
        </div>
        <div class="row">
          <button class="btn brand" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
          <div id="authErr" class="muted" style="color:#ef4444"></div>
        </div>
      </div>
    </section>
  </div>

  <div data-panel="tasks" class="hide">
    <section>
      <div class="grid two">
        <div>
          <h3 style="margin:0 0 6px">Ø£Ø¶Ù Ù…Ù‡Ù…Ø©</h3>
          <div class="grid">
            <textarea id="taskText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© (ÙŠØ³Ù…Ø­ Ø¨Ù†Øµ Ø·ÙˆÙŠÙ„)â€¦"></textarea>
            <input id="taskTag" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="btn brand" id="addTask">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙÙ†Ø¬Ø²Ø©</h3>
            <div class="muted">Ø¹Ø¯Ø¯: <span id="doneCount" class="stat">0</span></div>
          </div>
          <div class="list" id="doneList"></div>
        </div>
      </div>
      <div style="margin-top:8px">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø©</h3>
          <div class="muted">Ø¹Ø¯Ø¯: <span id="activeCount" class="stat">0</span></div>
        </div>
        <div class="list" id="tasksList"></div>
      </div>
    </section>
  </div>

  <div data-panel="products" class="hide">
    <section>
      <h3 style="margin:0 0 6px">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
      <div class="grid three">
        <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="pFactory" type="number" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹">
        <input id="pQty" type="number" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
      </div>
      <div class="grid two" style="margin-top:8px">
        <input id="pDistName" placeholder="Ø§Ø³Ù… Ù…ÙˆØ²Ù‘Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input id="pDistPrice" type="number" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <button class="btn brand" style="margin-top:8px" id="addProduct">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
      <div id="productsList" class="grid" style="margin-top:12px"></div>
    </section>
  </div>

  <div data-panel="calc" class="hide">
    <section>
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</h3>
        <div class="row"><label class="muted">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹:</label><select id="distSelect"></select></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµÙ†Ø¹</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</th>
          </tr></thead>
          <tbody id="calcTable"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:center;margin-top:12px;gap:20px;font-weight:800">
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµÙ†Ø¹: <span id="totFactory">0</span></div>
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹: <span id="totDist">0</span></div>
        <div>Ø§Ù„ÙØ±Ù‚ (Ø§Ù„Ø±Ø¨Ø­): <span id="totDiff">0</span></div>
      </div>
    </section>
  </div>

  <div data-panel="orders" class="hide">
    <section>
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø±</h3>
      <div class="grid two">
        <input id="oClient" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input id="oAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
      </div>
      <button class="btn brand" style="margin-top:8px" id="addOrder">Ø¥Ø¶Ø§ÙØ©</button>
      <div class="list" id="ordersList" style="margin-top:12px"></div>
      <div class="card" style="margin-top:8px"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª: </b><span id="sumOrders">0</span></div>
    </section>
  </div>

  <div data-panel="finance" class="hide">
    <section>
      <div class="grid two">
        <div>
          <h3 style="margin:0">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
          <div class="grid two">
            <input id="exDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <input id="exAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
          </div>
          <button class="btn red" style="margin-top:8px" id="addExpense">Ø¥Ø¶Ø§ÙØ©</button>
          <div id="expList" class="list" style="margin-top:8px"></div>
          <div class="card" style="margin-top:8px"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: </b><span id="sumExp">0</span></div>
        </div>
        <div>
          <h3 style="margin:0">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
          <div class="grid two">
            <input id="prDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <input id="prAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
          </div>
          <button class="btn ok" style="margin-top:8px" id="addProfit">Ø¥Ø¶Ø§ÙØ©</button>
          <div id="proList" class="list" style="margin-top:8px"></div>
          <div class="card" style="margin-top:8px"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: </b><span id="sumPro">0</span></div>
        </div>
      </div>
    </section>
  </div>

  <div data-panel="clients" class="hide">
    <section>
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</h3>
      <div class="grid two">
        <input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input id="cPhone" placeholder="Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <button class="btn brand" style="margin-top:8px" id="addClient">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="clientsList" class="list" style="margin-top:12px"></div>
    </section>
  </div>

  <div data-panel="inventory" class="hide">
    <section>
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ø®Ø²ÙˆÙ†</h3>
      <div class="grid three">
        <input id="iName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="iQty" type="number" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input id="iMin" type="number" step="1" placeholder="Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <button class="btn brand" style="margin-top:8px" id="addInv">Ø¥Ø¶Ø§ÙØ©</button>
      <div id="invList" class="list" style="margin-top:12px"></div>
    </section>
  </div>
</div>

<!-- ØªØ±Ø­ÙŠØ¨ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© -->
<div id="welcomeToast" class="toast">ğŸ‘‹ Welcome <b>Steven</b> and <b>Nassef</b></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ) */
  const firebaseConfig = {
    apiKey: "AIzaSyCnM6-7BoICLWAXUeH8qz8A_OCiCGpQtMU",
    authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
    projectId: "lynka-to-do-list-eb2ac",
    storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
    messagingSenderId: "202285237255",
    appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* Helpers */
  const $  = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const en = n => (Number(n||0)).toLocaleString('en-US',{maximumFractionDigits:2});
  const esc= s => String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;" }[m]));

  /* Tabs */
  const tabs=$$('#tabs .tab');
  const panels=$$('[data-panel]');
  function showTab(key){
    tabs.forEach(t=>t.classList.toggle('active',t.dataset.s===key));
    panels.forEach(p=>p.classList.toggle('hide',p.getAttribute('data-panel')!==key));
    sessionStorage.setItem('lynka_tab', key);
  }
  tabs.forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.s)));
  showTab('auth'); /* Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ */

  /* Toast once after first login */
  const toast=$('#welcomeToast');
  function welcomeOnce(){
    if(!localStorage.getItem('lynka_welcomed')){
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1000);
      setTimeout(()=>toast.remove(),1600);
      localStorage.setItem('lynka_welcomed','1');
    } else { toast.remove(); }
  }

  /* Auth UI */
  const userPill=$('#userPill'), userEmail=$('#userEmail');
  $('#btnLogin')?.addEventListener('click', async ()=>{
    const email=$('#inEmail').value.trim();
    const pass =$('#inPass').value.trim();
    $('#authErr').textContent='';
    try{ await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ $('#authErr').textContent='Ø®Ø·Ø£: '+(e.code||e.message); }
  });
  userPill.addEventListener('click', async ()=>{
    if(auth.currentUser) await signOut(auth);
    else showTab('auth');
  });

  /* Firestore Collections */
  const colTasks   = collection(db,'lynka_tasks');
  const colProds   = collection(db,'lynka_products');
  const colOrders  = collection(db,'lynka_orders');
  const colExp     = collection(db,'lynka_expenses');
  const colPro     = collection(db,'lynka_profits');
  const colClients = collection(db,'lynka_clients');
  const colInv     = collection(db,'lynka_inventory');

  /* Unsub management */
  let unsubs=[];
  function detachAll(){
    unsubs.forEach(u=>{try{u()}catch{}});
    unsubs=[];
    // clear UI
    ['#tasksList','#doneList','#productsList','#ordersList','#expList','#proList','#clientsList','#invList','#calcTable']
      .forEach(s=>{const el=$(s); if(el) el.innerHTML='';});
    ['#activeCount','#doneCount','#sumOrders','#sumExp','#sumPro','#totFactory','#totDist','#totDiff']
      .forEach(s=>{const el=$(s); if(el) el.textContent='0';});
    $('#distSelect').innerHTML='';
  }
  function requireAuth(){ if(!auth.currentUser){ showTab('auth'); throw new Error('not-auth'); } }

  /* ========= Modules (ØªØªÙØ¹Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·) ========= */
  let allProducts=[];

  function initTasks(){
    $('#addTask').onclick=async ()=>{
      try{
        requireAuth();
        const text=$('#taskText').value.trim();
        const tag =$('#taskTag').value.trim()||null;
        if(!text) return;
        await addDoc(colTasks,{text,tag,done:false,createdAt:serverTimestamp()});
        $('#taskText').value=''; $('#taskTag').value='';
      }catch{}
    };
    function taskItem(id,d){
      const it=document.createElement('div'); it.className='item'+(d.done?' item--done':'');
      it.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1">
          <div style="font-weight:800">${esc(d.text)}</div>
          <div class="muted" style="margin-top:4px">${d.tag?('#'+esc(d.tag)):'â€”'}</div>
        </div>
        <div class="row">
          <label class="row"><input type="checkbox" ${d.done?'checked':''} style="transform:scale(1.2)"><span>Ù…Ù†Ø¬Ø²</span></label>
          <button class="btn red">Ø­Ø°Ù</button>
        </div>
      </div>`;
      it.querySelector('input').addEventListener('change',()=>{ requireAuth(); updateDoc(doc(db,'lynka_tasks',id),{done:!d.done}); });
      it.querySelector('.btn.red').addEventListener('click',()=>{ requireAuth(); deleteDoc(doc(db,'lynka_tasks',id)); });
      return it;
    }
    const unsub=onSnapshot(query(colTasks,orderBy('createdAt','desc')),(snap)=>{
      const active=$('#tasksList'), done=$('#doneList'); active.innerHTML=''; done.innerHTML='';
      let a=0,dn=0;
      snap.forEach(s=>{
        const data=s.data(); const el=taskItem(s.id,data);
        if(data.done){ dn++; done.appendChild(el); } else { a++; active.appendChild(el); }
      });
      $('#activeCount').textContent=a; $('#doneCount').textContent=dn;
    });
    unsubs.push(unsub);
  }

  function initProducts(){
    $('#addProduct').onclick=async ()=>{
      try{
        requireAuth();
        const name=$('#pName').value.trim();
        const factory=parseFloat(($('#pFactory').value||'').toString().replace(',','.'));
        const qty=parseInt($('#pQty').value||'0',10);
        const dname=$('#pDistName').value.trim();
        const dprice=parseFloat(($('#pDistPrice').value||'').toString().replace(',','.'));
        if(!name || isNaN(factory) || !qty) return;
        const distributors={}; if(dname && !isNaN(dprice)) distributors[dname]=dprice;
        await addDoc(colProds,{name,factory,qty,distributors,createdAt:serverTimestamp()});
        ['#pName','#pFactory','#pQty','#pDistName','#pDistPrice'].forEach(s=>$(s).value='');
      }catch{}
    };
    function productCard(id,d){
      const card=document.createElement('div'); card.className='prod-card';
      card.innerHTML=`
        <div class="prod-head">
          <div style="font-weight:800">${esc(d.name)}</div>
          <div class="row">
            <button class="btn ghost" data-act="save">Ø­ÙØ¸</button>
            <button class="btn red" data-act="del">Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="grid three">
          <div><label class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹</label><input type="number" step="0.01" value="${d.factory??0}" data-f="factory"></div>
          <div><label class="muted">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" step="1" value="${d.qty??0}" data-f="qty"></div>
          <div><label class="muted">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ²Ù‘Ø¹</label>
            <div class="row"><input placeholder="Ø§Ø³Ù…" data-add-name><input type="number" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø±" data-add-price><button class="btn brand" data-act="addDist">Ø¥Ø¶Ø§ÙØ©</button></div>
          </div>
        </div>
        <div><label class="muted">Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹ÙŠÙ†</label><div class="list" data-dists></div></div>`;
      const dwrap=card.querySelector('[data-dists]'); dwrap.innerHTML='';
      Object.entries(d.distributors||{}).forEach(([name,price])=>{
        const row=document.createElement('div'); row.className='dist-row';
        row.innerHTML=`<input value="${esc(name)}" data-dn><input type="number" step="0.01" value="${price}" data-dp>
          <div class="row"><button class="btn ghost" data-act="upd">ØªØ­Ø¯ÙŠØ«</button><button class="btn red" data-act="del">Ø­Ø°Ù</button></div>`;
        row.querySelector('[data-act="upd"]').onclick=async ()=>{
          try{
            requireAuth();
            const newName=row.querySelector('[data-dn]').value.trim();
            const newPrice=parseFloat((row.querySelector('[data-dp]').value||'').toString().replace(',','.'));
            if(!newName || isNaN(newPrice)) return;
            const map={...(d.distributors||{})}; delete map[name]; map[newName]=newPrice;
            await updateDoc(doc(db,'lynka_products',id),{distributors:map});
          }catch{}
        };
        row.querySelector('[data-act="del"]').onclick=async ()=>{
          try{
            requireAuth();
            const map={...(d.distributors||{})}; delete map[name];
            await updateDoc(doc(db,'lynka_products',id),{distributors:map});
          }catch{}
        };
        dwrap.appendChild(row);
      });
      card.querySelector('[data-act="addDist"]').onclick=async ()=>{
        try{
          requireAuth();
          const n=card.querySelector('[data-add-name]').value.trim();
          const p=parseFloat((card.querySelector('[data-add-price]').value||'').toString().replace(',','.'));
          if(!n || isNaN(p)) return;
          const map={...(d.distributors||{})}; map[n]=p;
          await updateDoc(doc(db,'lynka_products',id),{distributors:map});
          card.querySelector('[data-add-name]').value=''; card.querySelector('[data-add-price]').value='';
        }catch{}
      };
      card.querySelector('[data-act="save"]').onclick=async ()=>{
        try{
          requireAuth();
          const factory=parseFloat((card.querySelector('[data-f="factory"]').value||'').toString().replace(',','.'));
          const qty=parseInt(card.querySelector('[data-f="qty"]').value||'0',10);
          if(isNaN(factory) || isNaN(qty)) return;
          await updateDoc(doc(db,'lynka_products',id),{factory,qty});
        }catch{}
      };
      card.querySelector('[data-act="del"]').onclick=async ()=>{ try{ requireAuth(); await deleteDoc(doc(db,'lynka_products',id)); }catch{} };
      return card;
    }
    const unsub=onSnapshot(query(colProds,orderBy('createdAt','desc')),(snap)=>{
      allProducts=[]; const wrap=$('#productsList'); wrap.innerHTML=''; const distSet=new Set();
      snap.forEach(s=>{
        const data=s.data(); allProducts.push({id:s.id,...data});
        Object.keys(data.distributors||{}).forEach(k=>distSet.add(k));
        wrap.appendChild(productCard(s.id,data));
      });
      const sel=$('#distSelect'); const cur=sel.value;
      sel.innerHTML=[...distSet].sort().map(n=>`<option value="${n}">${n}</option>`).join('');
      if([...distSet].includes(cur)) sel.value=cur;
      renderCalc();
    });
    unsubs.push(unsub);
  }

  function renderCalc(){
    const dist=$('#distSelect').value;
    const body=$('#calcTable'); body.innerHTML='';
    let totF=0,totD=0;
    allProducts.forEach(p=>{
      const price=(p.distributors||{})[dist];
      if(price==null) return;
      const f=(Number(p.factory)||0)*(Number(p.qty)||0);
      const d=(Number(price)||0)*(Number(p.qty)||0);
      totF+=f; totD+=d;
      body.insertAdjacentHTML('beforeend',`
        <tr><td>${esc(p.name)}</td><td>${en(p.factory)}</td><td>${en(p.qty)}</td>
        <td>${en(price)}</td><td>${en(f)}</td><td>${en(d)}</td></tr>`);
    });
    $('#totFactory').textContent=en(totF);
    $('#totDist').textContent=en(totD);
    $('#totDiff').textContent=en(totD-totF);
  }
  $('#distSelect').addEventListener('change', renderCalc);

  function initOrders(){
    $('#addOrder').onclick=async ()=>{
      try{
        requireAuth();
        const client=$('#oClient').value.trim();
        const amount=parseFloat(($('#oAmount').value||'').toString().replace(',','.'));
        if(!client || isNaN(amount)) return;
        await addDoc(colOrders,{client,amount,createdAt:serverTimestamp()});
        $('#oClient').value=''; $('#oAmount').value='';
      }catch{}
    };
    const unsub=onSnapshot(query(colOrders,orderBy('createdAt','desc')),(snap)=>{
      const L=$('#ordersList'); L.innerHTML=''; let sum=0;
      snap.forEach(s=>{
        const d=s.data(); sum+=Number(d.amount)||0;
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<div class="row" style="justify-content:space-between">
          <div style="font-weight:800">${esc(d.client)}</div>
          <div class="row"><div class="stat">${en(d.amount)}</div>
          <button class="btn red">Ø­Ø°Ù</button></div></div>`;
        it.querySelector('.btn.red').onclick=()=>{ requireAuth(); deleteDoc(doc(db,'lynka_orders',s.id)); };
        L.appendChild(it);
      });
      $('#sumOrders').textContent=en(sum);
    });
    unsubs.push(unsub);
  }

  function initFinance(){
    $('#addExpense').onclick=async ()=>{
      try{
        requireAuth();
        const desc=$('#exDesc').value.trim()||null;
        const amount=parseFloat(($('#exAmount').value||'').toString().replace(',','.'));
        if(isNaN(amount)) return;
        await addDoc(colExp,{desc,amount,createdAt:serverTimestamp()});
        $('#exDesc').value=''; $('#exAmount').value='';
      }catch{}
    };
    $('#addProfit').onclick=async ()=>{
      try{
        requireAuth();
        const desc=$('#prDesc').value.trim()||null;
        const amount=parseFloat(($('#prAmount').value||'').toString().replace(',','.'));
        if(isNaN(amount)) return;
        await addDoc(colPro,{desc,amount,createdAt:serverTimestamp()});
        $('#prDesc').value=''; $('#prAmount').value='';
      }catch{}
    };
    const un1=onSnapshot(query(colExp,orderBy('createdAt','desc')),(snap)=>{
      const L=$('#expList'); L.innerHTML=''; let sum=0;
      snap.forEach(s=>{
        const d=s.data(); sum+=Number(d.amount)||0;
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<div class="row" style="justify-content:space-between">
          <div>${d.desc?esc(d.desc):'<span class="muted">Ø¨Ø¯ÙˆÙ† ÙˆØµÙ</span>'}</div>
          <div class="row"><div class="stat">${en(d.amount)}</div>
          <button class="btn red">Ø­Ø°Ù</button></div></div>`;
        it.querySelector('.btn.red').onclick=()=>{ requireAuth(); deleteDoc(doc(db,'lynka_expenses',s.id)); };
        L.appendChild(it);
      });
      $('#sumExp').textContent=en(sum);
    });
    const un2=onSnapshot(query(colPro,orderBy('createdAt','desc')),(snap)=>{
      const L=$('#proList'); L.innerHTML=''; let sum=0;
      snap.forEach(s=>{
        const d=s.data(); sum+=Number(d.amount)||0;
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<div class="row" style="justify-content:space-between">
          <div>${d.desc?esc(d.desc):'<span class="muted">Ø¨Ø¯ÙˆÙ† ÙˆØµÙ</span>'}</div>
          <div class="row"><div class="stat">${en(d.amount)}</div>
          <button class="btn red">Ø­Ø°Ù</button></div></div>`;
        it.querySelector('.btn.red').onclick=()=>{ requireAuth(); deleteDoc(doc(db,'lynka_profits',s.id)); };
        L.appendChild(it);
      });
      $('#sumPro').textContent=en(sum);
    });
    unsubs.push(un1,un2);
  }

  function initClients(){
    $('#addClient').onclick=async ()=>{
      try{
        requireAuth();
        const name=$('#cName').value.trim();
        const phone=$('#cPhone').value.trim()||null;
        if(!name) return;
        await addDoc(colClients,{name,phone,createdAt:serverTimestamp()});
        $('#cName').value=''; $('#cPhone').value='';
      }catch{}
    };
    const unsub=onSnapshot(query(colClients,orderBy('createdAt','desc')),(snap)=>{
      const L=$('#clientsList'); L.innerHTML='';
      snap.forEach(s=>{
        const d=s.data();
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<div class="row" style="justify-content:space-between">
          <div style="font-weight:800">${esc(d.name)}</div>
          <div class="row"><div class="muted">${d.phone?esc(d.phone):'â€”'}</div>
          <button class="btn red">Ø­Ø°Ù</button></div></div>`;
        it.querySelector('.btn.red').onclick=()=>{ requireAuth(); deleteDoc(doc(db,'lynka_clients',s.id)); };
        L.appendChild(it);
      });
    });
    unsubs.push(unsub);
  }

  function initInventory(){
    $('#addInv').onclick=async ()=>{
      try{
        requireAuth();
        const name=$('#iName').value.trim();
        const qty=parseInt($('#iQty').value||'0',10);
        const min=parseInt($('#iMin').value||'0',10);
        if(!name || isNaN(qty)) return;
        await addDoc(colInv,{name,qty,min:(isNaN(min)?0:min),createdAt:serverTimestamp()});
        ['#iName','#iQty','#iMin'].forEach(s=>$(s).value='');
      }catch{}
    };
    const unsub=onSnapshot(query(colInv,orderBy('createdAt','desc')),(snap)=>{
      const L=$('#invList'); L.innerHTML='';
      snap.forEach(s=>{
        const d=s.data(); const low=(Number(d.qty)||0) <= (Number(d.min)||0);
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<div class="row" style="justify-content:space-between">
          <div style="font-weight:800">${esc(d.name)} ${low?'<span class="muted" style="color:#b91c1c">â€¢ Ù…Ù†Ø®ÙØ¶</span>':''}</div>
          <div class="row">
            <div class="stat">${en(d.qty)}</div>
            <button class="btn ghost" data-a="inc">+1</button>
            <button class="btn ghost" data-a="dec">-1</button>
            <button class="btn red">Ø­Ø°Ù</button>
          </div></div>`;
        it.querySelector('[data-a="inc"]').onclick=()=>{ requireAuth(); updateDoc(doc(db,'lynka_inventory',s.id),{qty:(Number(d.qty)||0)+1}); };
        it.querySelector('[data-a="dec"]').onclick=()=>{ requireAuth(); updateDoc(doc(db,'lynka_inventory',s.id),{qty:Math.max(0,(Number(d.qty)||0)-1)}); };
        it.querySelector('.btn.red').onclick=()=>{ requireAuth(); deleteDoc(doc(db,'lynka_inventory',s.id)); };
        L.appendChild(it);
      });
    });
    unsubs.push(unsub);
  }

  /* Auth state: Ø§Ø±Ø¨Ø·/Ø§ÙØµÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  onAuthStateChanged(auth, u=>{
    if(u){
      userEmail.textContent=u.email||'Ù…Ø³ØªØ®Ø¯Ù…';
      welcomeOnce();
      showTab(sessionStorage.getItem('lynka_tab')||'tasks');

      detachAll();
      /* attach all listeners AFTER login */
      initTasks(); initProducts(); initOrders(); initFinance(); initClients(); initInventory();
    }else{
      userEmail.textContent='ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      detachAll();
      showTab('auth');
    }
  });
</script>
</body>
</html>
