<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynka — لوحة الإدارة</title>
  <style>
    :root{
      --text:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
      --shadow:0 12px 40px rgba(2,6,23,.06); --radius:18px;

      /* خلفيات فاتحة جدًا لكل تبويب */
      --sec-tasks:#EAF4FF;     /* أزرق فاتح */
      --sec-prices:#F2E8FF;    /* بنفسجي فاتح */
      --sec-orders:#FFF4E5;    /* برتقالي فاتح */
      --sec-finance:#E9FFF1;   /* أخضر فاتح */
      --sec-clients:#FFEFF5;   /* وردي فاتح */
      --sec-inventory:#F0F4F8; /* رمادي أزرق فاتح */

      /* ألوان التابات */
      --tab-tasks:#4F7DF7;
      --tab-prices:#10B981;
      --tab-orders:#7C3AED;
      --tab-finance:#0EA5E9;
      --tab-clients:#F97316;
      --tab-inventory:#14B8A6;

      /* حالات المهام */
      --task-active-bg:#F2F8FF; /* غير منجزة */
      --task-done-bg:#ECFDF5;   /* منجزة */
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:#F6F8FC;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Tahoma,Arial}
    .wrap{max-width:1040px;margin:0 auto;padding:0 16px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .topbar .row{display:flex;align-items:center;gap:12px;padding:12px 0}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#5b6cff,#19c6d1);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}
    .brand h1{margin:0;font-size:20px}

    /* Tabs (Chrome-like) — التاب نفسه ملون */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;padding:10px 0 14px}
    .tab{
      --accent:#5b6cff;
      position:relative;padding:14px 20px;border:1px solid var(--line);border-bottom:none;
      background:color-mix(in oklab, var(--accent) 12%, #ffffff);
      border-top-left-radius:18px;border-top-right-radius:18px;font-weight:900;cursor:pointer;
      box-shadow:0 6px 20px rgba(2,6,23,.06);transform:translateY(6px);opacity:.94;color:#0b1220;
    }
    .tab .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-inline-end:8px;background:var(--accent)}
    .tab:hover{opacity:1}
    .tab.active{
      background:color-mix(in oklab, var(--accent) 22%, #ffffff);
      border-color:color-mix(in oklab, var(--accent) 45%, var(--line));
      transform:translateY(0);opacity:1;
      outline:3px solid color-mix(in oklab, var(--accent) 18%, transparent)
    }
    .tab[data-s="tasks"]{--accent:var(--tab-tasks)}
    .tab[data-s="prices"]{--accent:var(--tab-prices)}
    .tab[data-s="orders"]{--accent:var(--tab-orders)}
    .tab[data-s="finance"]{--accent:var(--tab-finance)}
    .tab[data-s="clients"]{--accent:var(--tab-clients)}
    .tab[data-s="inventory"]{--accent:var(--tab-inventory)}

    /* Cards / sections */
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:16px;margin:0 0 18px
    }
    /* كل قسم بياخد لون الخلفية الخاص بيه */
    .section[data-s="tasks"]{background:var(--sec-tasks)}
    .section[data-s="prices"]{background:var(--sec-prices)}
    .section[data-s="orders"]{background:var(--sec-orders)}
    .section[data-s="finance"]{background:var(--sec-finance)}
    .section[data-s="clients"]{background:var(--sec-clients)}
    .section[data-s="inventory"]{background:var(--sec-inventory)}

    .row-flex{display:flex;gap:10px;flex-wrap:wrap}
    .row-flex>*{flex:1 1 160px}
    input,select,textarea,button{border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;font-size:14px;outline:none}
    textarea{min-height:72px;resize:vertical}
    button{cursor:pointer;font-weight:800}
    .btn{color:#fff;border:none;background:linear-gradient(135deg, var(--accent), color-mix(in oklab,var(--accent) 60%, #8be9ff))}
    .btn-ghost{background:#f3f4f6}
    .danger{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff;border:none}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .item{display:flex;gap:10px;align-items:flex-start;background:#fff;border:1px solid var(--line);padding:12px;border-radius:12px}
    .item-title{font-weight:800}
    .item-sub{color:var(--muted);font-size:12px}

    /* Prices */
    .price-big{font-size:22px;font-weight:900;letter-spacing:.2px}

    /* Tasks states */
    .item.task.active{background:var(--task-active-bg)}
    .item.task.done{background:var(--task-done-bg)}
    .item.task.done .item-title{ text-decoration: line-through; opacity:.85 }

    /* Finance 2-cols */
    .two-col{display:grid;gap:14px}
    @media(min-width:800px){ .two-col{grid-template-columns:1fr 1fr} }
    .total{display:flex;justify-content:space-between;gap:10px;margin-top:8px;font-weight:900}
    .net{display:flex;justify-content:center;gap:16px;align-items:center;margin-top:12px;padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fafcff}

    /* KPI */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
    .kpi .n{font-weight:900;font-size:20px}

    .hide{display:none} .muted{color:var(--muted)}

    /* Welcome (ضمان الاختفاء) */
    #welcome{
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2563EB;
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 18px;
      box-shadow: 0 10px 30px rgba(2,6,23,.15);
      opacity: 0;
      transition: opacity .25s ease;
      z-index: 9999;
      display: none;
    }
    #welcome.show{ display:block !important; opacity:1 !important; }
    #welcome.hide{ display:none !important; opacity:0 !important; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="brand"><div class="logo">L</div><h1>Lynka — لوحة الإدارة</h1></div>
      <div style="margin-inline-start:auto;display:flex;align-items:center;gap:8px">
        <span id="userEmail" class="muted" style="display:none;font-size:12px"></span>
        <button id="logoutBtn" class="tab" style="--accent:#6b7280;padding:8px 14px;transform:none;border-bottom:1px solid var(--line)">تسجيل الخروج</button>
      </div>
    </div>
    <div class="wrap tabs" id="tabs">
      <div class="tab active" data-s="tasks"><span class="dot"></span>المهام</div>
      <div class="tab" data-s="prices"><span class="dot"></span>الأسعار</div>
      <div class="tab" data-s="orders"><span class="dot"></span>الأوردرات</div>
      <div class="tab" data-s="finance"><span class="dot"></span>مصروفات وأرباح</div>
      <div class="tab" data-s="clients"><span class="dot"></span>العملاء</div>
      <div class="tab" data-s="inventory"><span class="dot"></span>المخزون</div>
    </div>
  </div>

  <!-- Auth -->
  <div class="wrap" id="authCard" style="margin-top:16px">
    <div class="card section" data-s="tasks" style="text-align:center">
      <h2 style="margin:6px 0 12px">تسجيل دخول Lynka</h2>
      <div class="row-flex">
        <input id="email" placeholder="1@lynka.com أو 2@lynka.com" />
        <input id="password" type="password" placeholder="••••••••" />
        <button class="btn" id="loginBtn" style="--accent:#5b6cff">دخول</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px;color:#b91c1c"></div>
    </div>
  </div>

  <!-- Welcome (يظهر 1 ثانية ويختفي أكيد) -->
  <div id="welcome">Welcome Steven and Nassef</div>

  <div class="wrap hide" id="app" style="margin-top:16px">
    <div class="kpis">
      <div class="kpi"><div class="muted" style="font-size:12px">مهام نشطة</div><div class="n" id="kpiTasks">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">طلبات</div><div class="n" id="kpiOrders">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">إجمالي أرباح</div><div class="n" id="kpiRev">0</div></div>
      <div class="kpi"><div class="muted" style="font-size:12px">إجمالي مصروفات</div><div class="n" id="kpiExp">0</div></div>
    </div>

    <!-- TASKS -->
    <section id="s-tasks" class="card section" data-s="tasks">
      <h3 style="margin-top:0">قائمة المهام</h3>
      <div class="row-flex">
        <textarea id="taskText" placeholder="اكتب مهمة (يسمح بنص طويل)…"></textarea>
        <select id="taskTag" title="اختياري">
          <option value="">— وسم (اختياري | optional) —</option>
          <option>مهم</option><option>عميل</option><option>توصيل</option>
        </select>
        <input type="date" id="taskDue" placeholder="تاريخ (اختياري | optional)" title="اختياري">
        <button class="btn" id="addTask" style="--accent:var(--tab-tasks)">إضافة</button>
        <button class="btn-ghost" id="clearSelectedTasks">حذف المحدد</button>
      </div>

      <div class="row-flex" style="margin-top:10px">
        <input id="taskSearch" placeholder="بحث… (اختياري | optional)" />
        <select id="taskFilter">
          <option value="all">الكل</option>
          <option value="today">اليوم</option>
          <option value="overdue">متأخرة</option>
          <option value="tag">حسب الوسم</option>
        </select>
      </div>

      <h4 style="margin:16px 0 6px">المهام النشطة</h4>
      <div class="list" id="tasksActive"></div>

      <h4 style="margin:22px 0 6px">المهام المُنجزة</h4>
      <div class="list" id="tasksDone"></div>
    </section>

    <!-- PRICES -->
    <section id="s-prices" class="card section" data-s="prices">
      <h3 style="margin-top:0">الأسعار</h3>
      <div class="row-flex">
        <input id="pName" placeholder="اسم المنتج" />
        <input id="pRetail" type="number" step="0.01" placeholder="سعر التجزئة" />
        <input id="pWholesale" type="number" step="0.01" placeholder="سعر الجملة (اختياري | optional)" />
        <select id="pUnit"><option>قطعة</option><option>علبة</option><option>كيلو</option></select>
        <button class="btn" id="addPrice" style="--accent:var(--tab-prices)">إضافة</button>
      </div>
      <div class="list" id="pricesList"></div>
    </section>

    <!-- ORDERS -->
    <section id="s-orders" class="card section" data-s="orders">
      <h3 style="margin-top:0">الأوردرات</h3>
      <div class="row-flex">
        <input id="oClient" placeholder="اسم العميل (اختياري | optional)" />
        <input id="oTitle" placeholder="وصف مختصر للطلب" />
        <input id="oAmount" type="number" step="0.01" placeholder="الإجمالي (اختياري | optional)" />
        <select id="oStatus"><option>جديد</option><option>قيد التنفيذ</option><option>تم</option><option>ملغي</option></select>
        <button class="btn" id="addOrder" style="--accent:var(--tab-orders)">إضافة</button>
      </div>
      <div class="list" id="ordersList"></div>
    </section>

    <!-- FINANCE -->
    <section id="s-finance" class="card section" data-s="finance">
      <h3 style="margin-top:0">مصروفات وأرباح</h3>
      <div class="two-col">
        <!-- Expenses -->
        <div>
          <div class="row-flex">
            <input id="exCat" placeholder="فئة المصروف" />
            <input id="exAmount" type="number" step="0.01" placeholder="القيمة" />
            <input id="exNote" placeholder="ملاحظات (اختياري | optional)" />
            <button class="btn" id="addExpense" style="--accent:var(--tab-finance)">إضافة</button>
          </div>
          <div class="list" id="expensesList"></div>
          <div class="total"><span>إجمالي المصروفات</span><span id="expTotal">0</span></div>
        </div>

        <!-- Revenues -->
        <div>
          <div class="row-flex">
            <input id="revCat" placeholder="فئة الربح" />
            <input id="revAmount" type="number" step="0.01" placeholder="القيمة" />
            <input id="revNote" placeholder="ملاحظات (اختياري | optional)" />
            <button class="btn" id="addRevenue" style="--accent:var(--tab-finance)">إضافة</button>
          </div>
          <div class="list" id="revenuesList"></div>
          <div class="total"><span>إجمالي الأرباح</span><span id="revTotal">0</span></div>
        </div>
      </div>

      <div class="net">
        <div class="muted">صافي الربح:</div>
        <div id="netTotal" style="font-weight:900">0</div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="s-clients" class="card section" data-s="clients">
      <h3 style="margin-top:0">العملاء</h3>
      <div class="row-flex">
        <input id="cName" placeholder="الاسم" />
        <input id="cPhone" placeholder="الموبايل (اختياري | optional)" />
        <input id="cEmail" placeholder="البريد (اختياري | optional)" />
        <input id="cAddress" placeholder="العنوان (اختياري | optional)" />
        <input id="cNote" placeholder="ملاحظات (اختياري | optional)" />
        <button class="btn" id="addClient" style="--accent:var(--tab-clients)">إضافة</button>
      </div>
      <div class="list" id="clientsList"></div>
    </section>

    <!-- INVENTORY -->
    <section id="s-inventory" class="card section" data-s="inventory">
      <h3 style="margin-top:0">المخزون</h3>
      <div class="row-flex">
        <input id="iName" placeholder="اسم المنتج" />
        <input id="iQty" type="number" step="1" placeholder="الكمية" />
        <input id="iMin" type="number" step="1" placeholder="حد التنبيه (اختياري | optional)" />
        <input id="iSupplier" placeholder="المورد (اختياري | optional)" />
        <button class="btn" id="addInv" style="--accent:var(--tab-inventory)">إضافة</button>
      </div>
      <div class="list" id="invList"></div>
    </section>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script>
    // إعداداتك الحالية (سيبها زي ما هي)
    const firebaseConfig = {
      apiKey: "AIzaSyCnM6-7BoICLWAXUeH8qz8A_OCiCGpQtMU",
      authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
      projectId: "lynka-to-do-list-eb2ac",
      storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
      messagingSenderId: "202285237255",
      appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Helpers
    const $ = s => document.querySelector(s);
    const show = el => el.classList.remove('hide');
    const hide = el => el.classList.add('hide');
    const fmt = n => (Number(n||0)).toLocaleString('en-US',{maximumFractionDigits:2}); // English numbers

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.querySelectorAll('section[id^="s-"]').forEach(s=>hide(s));
      show($('#s-'+t.dataset.s));
    }));

    // Welcome (1s, guaranteed)
    function showWelcome(duration = 1000){
      const el = document.getElementById('welcome');
      if(!el) return;
      el.classList.remove('hide');
      el.classList.add('show');
      setTimeout(()=>{
        el.classList.remove('show');
        el.classList.add('hide');   // display:none
      }, duration);
    }

    // Auth
    $('#loginBtn').onclick = async()=>{
      $('#authMsg').textContent='';
      try{
        await auth.signInWithEmailAndPassword($('#email').value.trim(), $('#password').value.trim());
      }catch(e){ $('#authMsg').textContent = 'Firebase: '+(e.message||'خطأ'); }
    };
    auth.onAuthStateChanged(u=>{
      if(u){
        hide($('#authCard')); show($('#app'));
        $('#userEmail').textContent = u.email; $('#userEmail').style.display='inline'; $('#logoutBtn').style.display='inline';
        initApp();
        showWelcome(1000); // ثانية واحدة فقط
      } else {
        show($('#authCard')); hide($('#app'));
        $('#userEmail').style.display='none'; $('#logoutBtn').style.display='none';
      }
    });
    $('#logoutBtn').onclick=()=>auth.signOut();

    // Collections
    const col = {
      tasks: db.collection('tasks'),
      products: db.collection('products'),
      orders: db.collection('orders'),
      expenses: db.collection('expenses'),
      revenues: db.collection('revenues'),
      clients: db.collection('clients'),
      inventory: db.collection('inventory'),
    };

    // ================= TASKS =================
    $('#addTask').onclick = async()=>{
      const text = $('#taskText').value.trim(); if(!text) return;
      await col.tasks.add({
        text, done:false, tag:$('#taskTag').value||'', due:$('#taskDue').value||'',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#taskText').value=''; $('#taskTag').value=''; $('#taskDue').value='';
    };
    $('#clearSelectedTasks').onclick = ()=>{
      document.querySelectorAll('.taskSel:checked').forEach(ch=>{
        col.tasks.doc(ch.dataset.id).delete();
      });
    };
    const isOverdue = due=>{
      if(!due) return false;
      const today = new Date().toISOString().slice(0,10);
      return due < today;
    };
    function renderTask(doc, container){
      const d = doc.data();
      const row = document.createElement('div');
      row.className = 'item task ' + (d.done ? 'done' : 'active');
      row.innerHTML = `
        <input type="checkbox" class="taskSel" data-id="${doc.id}">
        <div style="flex:1">
          <div class="item-title">${(d.text||'').replace(/\n/g,'<br>')}</div>
          <div class="item-sub">
            ${d.tag?`<span class="item-sub">#${d.tag}</span>`:''}
            ${d.due?` • <span class="item-sub" style="color:${(!d.done && isOverdue(d.due))?'#b91c1c':'inherit'}">${d.due}</span>`:''}
          </div>
        </div>
        <div class="item-sub" style="display:grid;gap:6px">
          <button class="btn-ghost" data-act="toggle">${d.done?'غير مُنجزة':'إنهاء'}</button>
          <button class="danger" data-act="del">حذف</button>
        </div>`;
      row.querySelector('[data-act="toggle"]').onclick=()=>col.tasks.doc(doc.id).update({done:!d.done, updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
      row.querySelector('[data-act="del"]').onclick=()=>col.tasks.doc(doc.id).delete();
      container.appendChild(row);
    }
    function loadTasks(){
      const A=$('#tasksActive'), D=$('#tasksDone');
      const s = $('#taskSearch').value.trim();
      col.tasks.orderBy('createdAt','desc').onSnapshot(ss=>{
        A.innerHTML=''; D.innerHTML=''; let active=0;
        ss.forEach(doc=>{
          const d=doc.data();
          if(s && !String(d.text).includes(s)) return;
          const target = d.done ? D : A;
          renderTask(doc, target);
          if(!d.done) active++;
        });
        $('#kpiTasks').textContent = fmt(active);
      });
    }
    $('#taskSearch').oninput = loadTasks;

    // ================= PRICES =================
    $('#addPrice').onclick = async()=>{
      const name=$('#pName').value.trim(); if(!name) return;
      await col.products.add({
        name, unit:$('#pUnit').value,
        retail: Number($('#pRetail').value||0),
        wholesale: Number($('#pWholesale').value||0),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#pName').value=''; $('#pRetail').value=''; $('#pWholesale').value='';
    };
    function loadPrices(){
      const L=$('#pricesList'); L.innerHTML='';
      col.products.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML='';
        ss.forEach(doc=>{
          const d=doc.data();
          const el=document.createElement('div');
          el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.name} <span class="item-sub">(${d.unit||'Unit'})</span></div>
              <div class="item-sub">Wholesale: <b>${fmt(d.wholesale)}</b></div>
            </div>
            <div class="price-big">${fmt(d.retail)}</div>
            <button class="danger">حذف</button>`;
          el.querySelector('button').onclick=()=>col.products.doc(doc.id).delete();
          L.appendChild(el);
        });
      });
    }

    // ================= ORDERS =================
    $('#addOrder').onclick = async()=>{
      const client=$('#oClient').value.trim();
      const title=$('#oTitle').value.trim();
      const amount=Number($('#oAmount').value||0);
      await col.orders.add({
        client, title, amount, status:$('#oStatus').value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#oClient').value=''; $('#oTitle').value=''; $('#oAmount').value='';
    };
    function loadOrders(){
      const L=$('#ordersList');
      col.orders.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML=''; let count=0;
        ss.forEach(doc=>{
          const d=doc.data(); count++;
          const el=document.createElement('div');
          el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.title||'طلب'}</div>
              <div class="item-sub">عميل: <b>${d.client||'-'}</b> • حالة: <b>${d.status}</b> • إجمالي: <b>${fmt(d.amount)}</b></div>
            </div>
            <div class="item-sub" style="display:grid;gap:6px">
              <button class="btn-ghost" data-act="done">إنهاء</button>
              <button class="danger" data-act="del">حذف</button>
            </div>`;
          el.querySelector('[data-act="done"]').onclick=()=>col.orders.doc(doc.id).update({status:'تم'});
          el.querySelector('[data-act="del"]').onclick=()=>col.orders.doc(doc.id).delete();
          L.appendChild(el);
        });
        $('#kpiOrders').textContent = fmt(count);
      });
    }

    // ================= FINANCE =================
    $('#addExpense').onclick = async()=>{
      const cat=$('#exCat').value.trim(); const amount=Number($('#exAmount').value||0);
      await col.expenses.add({
        category:cat, amount, note:$('#exNote').value.trim(),
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#exCat').value=''; $('#exAmount').value=''; $('#exNote').value='';
    };
    $('#addRevenue').onclick = async()=>{
      const cat=$('#revCat').value.trim(); const amount=Number($('#revAmount').value||0);
      await col.revenues.add({
        category:cat, amount, note:$('#revNote').value.trim(),
        date: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#revCat').value=''; $('#revAmount').value=''; $('#revNote').value='';
    };
    function financeRow(d, del){
      const el=document.createElement('div');
      el.className='item';
      el.innerHTML=`
        <div style="flex:1">
          <div class="item-title">${d.category||'-'}</div>
          <div class="item-sub">${d.note||''}</div>
        </div>
        <div style="font-weight:900">${fmt(d.amount)}</div>
        <button class="danger">حذف</button>`;
      el.querySelector('button').onclick = del;
      return el;
    }
    function updateNet(){
      const rev = Number(($('#revTotal').textContent||'0').replace(/,/g,''))||0;
      const exp = Number(($('#expTotal').textContent||'0').replace(/,/g,''))||0;
      $('#netTotal').textContent = fmt(rev - exp);
    }
    function loadExpenses(){
      const L=$('#expensesList'); L.innerHTML='';
      col.expenses.orderBy('date','desc').onSnapshot(ss=>{
        L.innerHTML=''; let sum=0;
        ss.forEach(doc=>{
          const d=doc.data(); sum += Number(d.amount)||0;
          L.appendChild(financeRow(d, ()=>col.expenses.doc(doc.id).delete()));
        });
        $('#expTotal').textContent = fmt(sum);
        $('#kpiExp').textContent  = fmt(sum);
        updateNet();
      });
    }
    function loadRevenues(){
      const L=$('#revenuesList'); L.innerHTML='';
      col.revenues.orderBy('date','desc').onSnapshot(ss=>{
        L.innerHTML=''; let sum=0;
        ss.forEach(doc=>{
          const d=doc.data(); sum += Number(d.amount)||0;
          L.appendChild(financeRow(d, ()=>col.revenues.doc(doc.id).delete()));
        });
        $('#revTotal').textContent = fmt(sum);
        $('#kpiRev').textContent  = fmt(sum);
        updateNet();
      });
    }

    // ================= CLIENTS =================
    $('#addClient').onclick=async()=>{
      const name=$('#cName').value.trim(); if(!name) return;
      await col.clients.add({
        name, phone:$('#cPhone').value.trim(), email:$('#cEmail').value.trim(),
        address:$('#cAddress').value.trim(), note:$('#cNote').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      ['#cName','#cPhone','#cEmail','#cAddress','#cNote'].forEach(s=>$(s).value='');
    };
    function loadClients(){
      const L=$('#clientsList'); L.innerHTML='';
      col.clients.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML='';
        ss.forEach(doc=>{
          const d=doc.data();
          const el=document.createElement('div'); el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.name}</div>
              <div class="item-sub">${d.phone||''} • ${d.email||''} • ${d.address||''}</div>
              <div class="item-sub">${d.note||''}</div>
            </div>
            <button class="danger">حذف</button>`;
          el.querySelector('button').onclick=()=>col.clients.doc(doc.id).delete();
          L.appendChild(el);
        });
      });
    }

    // ================= INVENTORY =================
    $('#addInv').onclick=async()=>{
      const name=$('#iName').value.trim(); if(!name) return;
      await col.inventory.add({
        name, qty:Number($('#iQty').value||0), min:Number($('#iMin').value||0),
        supplier:$('#iSupplier').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      ['#iName','#iQty','#iMin','#iSupplier'].forEach(s=>$(s).value='');
    };
    function loadInventory(){
      const L=$('#invList'); L.innerHTML='';
      col.inventory.orderBy('createdAt','desc').onSnapshot(ss=>{
        L.innerHTML='';
        ss.forEach(doc=>{
          const d=doc.data();
          const low = (Number(d.qty)||0) <= (Number(d.min)||0);
          const el=document.createElement('div'); el.className='item';
          el.innerHTML=`
            <div style="flex:1">
              <div class="item-title">${d.name} ${low?'<span class="item-sub" style="color:#b91c1c">• منخفض</span>':''}</div>
              <div class="item-sub">كمية: <b>${fmt(d.qty)}</b> • حد التنبيه: <b>${fmt(d.min)}</b> • المورد: ${d.supplier||'-'}</div>
            </div>
            <div class="item-sub" style="display:grid;gap:6px">
              <button class="btn-ghost" data-act="inc">+1</button>
              <button class="btn-ghost" data-act="dec">-1</button>
              <button class="danger" data-act="del">حذف</button>
            </div>`;
          el.querySelector('[data-act="inc"]').onclick=()=>col.inventory.doc(doc.id).update({qty:(Number(d.qty)||0)+1});
          el.querySelector('[data-act="dec"]').onclick=()=>col.inventory.doc(doc.id).update({qty:Math.max(0,(Number(d.qty)||0)-1)});
          el.querySelector('[data-act="del"]').onclick=()=>col.inventory.doc(doc.id).delete();
          L.appendChild(el);
        });
      });
    }

    // Init
    function initApp(){
      loadTasks(); loadPrices(); loadOrders();
      loadExpenses(); loadRevenues();
      loadClients(); loadInventory();
    }
  </script>
</body>
</html>
