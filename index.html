<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lynka — لوحة الإدارة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#0b1220; --muted:#64748b; --line:#e5e7eb; --card:#fff; --bg:#f6f8fc;
    --shadow:0 10px 30px rgba(2,6,23,.08); --r:16px;
    /* تبويبات */
    --t-products:#4F7DF7; --t-calc:#10B981; --t-orders:#7C3AED; --t-finance:#0EA5E9; --t-clients:#F97316;
    /* خلفيات خفيفة لكل تبويب */
    --s-products:#EAF4FF; --s-calc:#E9FFF1; --s-orders:#F2E8FF; --s-finance:#E7F7FF; --s-clients:#FFF1E8;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Cairo",system-ui}
  .wrap{max-width:1100px;margin:auto;padding:0 14px}

  /* شريط علوي */
  .top{position:sticky;top:0;z-index:30;background:linear-gradient(#fff,rgba(255,255,255,.9));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .top .row{display:flex;align-items:center;gap:10px;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
        background:linear-gradient(135deg,#5b6cff,#19c6d1);color:#fff;font-weight:900;box-shadow:var(--shadow)}
  .brand h1{margin:0;font-size:20px}
  .user{margin-inline-start:auto;display:flex;align-items:center;gap:8px}
  .pill{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
  .logout{padding:8px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}

  /* Tabs (شكل شبه كروم) */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px 0 12px}
  .tab{--c:#4F7DF7; position:relative; padding:12px 16px; border:1px solid var(--line); border-bottom:none;
       border-top-left-radius:14px;border-top-right-radius:14px; cursor:pointer; font-weight:900;
       background:color-mix(in oklab, var(--c) 14%, #fff); transform:translateY(6px); box-shadow:var(--shadow); opacity:.95}
  .tab.active{transform:translateY(0); background:color-mix(in oklab, var(--c) 22%, #fff); outline:3px solid color-mix(in oklab, var(--c) 18%, transparent)}
  .tab .dot{display:inline-block;width:10px;height:10px;border-radius:999px;background:var(--c);margin-inline-end:8px}
  .tab[data-s="products"]{--c:var(--t-products)}
  .tab[data-s="calc"]{--c:var(--t-calc)}
  .tab[data-s="orders"]{--c:var(--t-orders)}
  .tab[data-s="finance"]{--c:var(--t-finance)}
  .tab[data-s="clients"]{--c:var(--t-clients)}

  /* أقسام */
  section{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:0 0 16px}
  .sec[data-s="products"]{background:var(--s-products)}
  .sec[data-s="calc"]{background:var(--s-calc)}
  .sec[data-s="orders"]{background:var(--s-orders)}
  .sec[data-s="finance"]{background:var(--s-finance)}
  .sec[data-s="clients"]{background:var(--s-clients)}
  .grid{display:grid;gap:10px} .grid.two{grid-template-columns:1fr 1fr}
  .row{display:flex;gap:10px;flex-wrap:wrap} .row>*{flex:1 1 160px}
  input,select,textarea,button{border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:#fff;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  button{cursor:pointer;font-weight:900}
  .btn{color:#fff;border:none;background:linear-gradient(135deg,var(--c),color-mix(in oklab,var(--c) 60%, #9be9ff))}
  .ghost{background:#f3f4f6}
  .danger{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff;border:none}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);background:#fff;padding:12px;border-radius:12px}
  .title{font-weight:900} .muted{color:var(--muted)} .hide{display:none}
  .price-big{font-size:20px;font-weight:900}

  /* شاشة الدخول Fullscreen */
  .auth-screen{
    position:fixed; inset:0; z-index:40; background:
      radial-gradient(1200px 600px at 80% -10%, #dbedff 0%, transparent 60%),
      radial-gradient(1000px 600px at -10% 100%, #eafbf3 0%, transparent 60%),
      #ffffff;
    display:grid; place-items:center; border-bottom:1px solid var(--line);
  }
  .auth-card{width:min(92vw,560px); background:#fff; border:1px solid var(--line); border-radius:18px; box-shadow:var(--shadow); padding:18px}
  .auth-title{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:10px}
  .auth-logo{width:54px;height:54px;border-radius:14px;background:linear-gradient(135deg,#5b6cff,#19c6d1);display:grid;place-items:center;color:#fff;font-weight:900;box-shadow:var(--shadow)}

  /* Toast ترحيب ثانية واحدة */
  #welcome{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#2563EB;color:#fff;
           padding:10px 16px;border-radius:12px;box-shadow:var(--shadow);opacity:0;display:none;z-index:50}
  #welcome.show{display:block;opacity:1}
  #welcome.hide{display:none !important;opacity:0 !important}

  @media(max-width:800px){ .grid.two{grid-template-columns:1fr} .tab{font-size:14px} .price-big{font-size:18px} }
</style>
</head>
<body>

<!-- شاشة الدخول (أول صفحة) -->
<div id="auth" class="auth-screen">
  <div class="auth-card">
    <div class="auth-title">
      <div class="auth-logo">L</div>
      <h2 style="margin:0">تسجيل دخول Lynka</h2>
    </div>
    <div class="row">
      <input id="email" placeholder="1@lynka.com أو 2@lynka.com">
      <input id="pass" type="password" placeholder="87654321">
      <button class="btn" style="--c:#4F7DF7" id="loginBtn">دخول</button>
    </div>
    <div id="authErr" class="muted" style="margin-top:6px;color:#b91c1c"></div>
  </div>
</div>

<!-- Toast -->
<div id="welcome">Welcome Steven and Nassef</div>

<!-- التطبيق -->
<div id="app" class="hide">
  <div class="top">
    <div class="wrap row">
      <div class="brand"><div class="logo">L</div><h1>Lynka — لوحة الإدارة</h1></div>
      <div class="user">
        <span id="userMail" class="pill hide"></span>
        <button id="logoutBtn" class="logout hide">تسجيل الخروج</button>
      </div>
    </div>
    <div class="wrap tabs" id="tabs">
      <div class="tab active" data-s="products"><span class="dot"></span>المنتجات</div>
      <div class="tab" data-s="calc"><span class="dot"></span>الحساب</div>
      <div class="tab" data-s="orders"><span class="dot"></span>الأوردرات</div>
      <div class="tab" data-s="finance"><span class="dot"></span>مصروفات وأرباح</div>
      <div class="tab" data-s="clients"><span class="dot"></span>العملاء</div>
    </div>
  </div>

  <div class="wrap" style="margin-top:14px">

    <!-- PRODUCTS -->
    <section id="s-products" class="sec" data-s="products">
      <h3 style="margin:0 0 10px">المنتجات + الموزعين</h3>
      <div class="row">
        <input id="pName"      placeholder="اسم المنتج">
        <input id="pFactory"   type="number" step="0.01" placeholder="سعر المصنع">
        <input id="pQty"       type="number" step="1" placeholder="الكمية">
        <select id="pUnit"><option>قطعة</option><option>علبة</option><option>كيلو</option></select>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="pDistName"  placeholder="اسم موزّع (اختياري)">
        <input id="pDistPrice" type="number" step="0.01" placeholder="سعر الموزّع (اختياري)">
        <button class="btn" style="--c:var(--t-products)" id="addProduct">إضافة المنتج</button>
      </div>
      <div id="productsList" class="grid" style="margin-top:12px"></div>
    </section>

    <!-- CALC -->
    <section id="s-calc" class="sec" data-s="calc">
      <h3 style="margin:0 0 10px">الحساب حسب الموزّع</h3>
      <div class="row">
        <select id="distSelect"></select>
      </div>
      <div class="card">
        <div class="grid" style="gap:8px">
          <div class="row" style="font-weight:900">
            <div>إجمالي المصنع: <span id="totFactory">0</span></div>
            <div>إجمالي الموزّع: <span id="totDist">0</span></div>
            <div>الفرق (الربح): <span id="totDiff">0</span></div>
          </div>
          <div class="list" id="calcList"></div>
        </div>
      </div>
    </section>

    <!-- ORDERS -->
    <section id="s-orders" class="sec" data-s="orders">
      <h3 style="margin:0 0 10px">الأوردرات</h3>
      <div class="row">
        <input id="oClient" placeholder="اسم العميل (اختياري)">
        <input id="oTitle"  placeholder="وصف مختصر">
        <input id="oAmount" type="number" step="0.01" placeholder="الإجمالي (اختياري)">
        <select id="oStatus"><option>جديد</option><option>قيد التنفيذ</option><option>تم</option><option>ملغي</option></select>
        <button class="btn" style="--c:var(--t-orders)" id="addOrder">إضافة</button>
      </div>
      <div class="list" id="ordersList" style="margin-top:10px"></div>
    </section>

    <!-- FINANCE -->
    <section id="s-finance" class="sec" data-s="finance">
      <h3 style="margin:0 0 10px">مصروفات وأرباح</h3>
      <div class="grid two">
        <div class="card">
          <div class="row">
            <input id="exCat" placeholder="فئة المصروف">
            <input id="exAmount" type="number" step="0.01" placeholder="القيمة">
            <input id="exNote" placeholder="ملاحظات (اختياري)">
            <button class="btn" style="--c:var(--t-finance)" id="addExpense">إضافة</button>
          </div>
          <div class="list" id="expList" style="margin-top:10px"></div>
          <div class="row" style="font-weight:900;justify-content:space-between"><span>إجمالي المصروفات</span><span id="sumExp">0</span></div>
        </div>
        <div class="card">
          <div class="row">
            <input id="revCat" placeholder="فئة الربح">
            <input id="revAmount" type="number" step="0.01" placeholder="القيمة">
            <input id="revNote" placeholder="ملاحظات (اختياري)">
            <button class="btn" style="--c:var(--t-finance)" id="addRevenue">إضافة</button>
          </div>
          <div class="list" id="revList" style="margin-top:10px"></div>
          <div class="row" style="font-weight:900;justify-content:space-between"><span>إجمالي الأرباح</span><span id="sumRev">0</span></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px;display:flex;gap:14px;justify-content:center;font-weight:900">
        <div>صافي الربح: <span id="netTotal">0</span></div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="s-clients" class="sec" data-s="clients">
      <h3 style="margin:0 0 10px">العملاء</h3>
      <div class="row">
        <input id="cName" placeholder="الاسم">
        <input id="cPhone" placeholder="الموبايل (اختياري)">
        <input id="cEmail" placeholder="البريد (اختياري)">
        <input id="cAddress" placeholder="العنوان (اختياري)">
        <input id="cNote" placeholder="ملاحظات (اختياري)">
        <button class="btn" style="--c:var(--t-clients)" id="addClient">إضافة</button>
      </div>
      <div class="list" id="clientsList" style="margin-top:10px"></div>
    </section>

  </div>
</div>

<!-- Firebase compat (نفس ما كان شغال معاك) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
  /* ===== إعدادات مشروعك ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCnM6-7BoICLWAXUeH8qz8A_OCiCGpQtMU",
    authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
    projectId: "lynka-to-do-list-eb2ac",
    storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
    messagingSenderId: "202285237255",
    appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const $$= s => document.querySelectorAll(s);
  const show = el => el.classList.remove('hide');
  const hide = el => el.classList.add('hide');
  const en  = n => (Number(n||0)).toLocaleString('en-US',{maximumFractionDigits:2}); // أرقام إنجليزي

  /* ===== Tabs ===== */
  const tabs = $$('#tabs .tab');
  function showSec(key){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.s===key));
    $$('section.sec').forEach(s=>s.id==='s-'+key?show(s):hide(s));
    sessionStorage.setItem('lynka_tab', key);
  }
  tabs.forEach(t=>t.addEventListener('click',()=>showSec(t.dataset.s)));

  /* ===== Welcome toast (ثانية واحدة) ===== */
  function welcomeOnce(){
    const w = $('#welcome');
    if(!localStorage.getItem('lynka_welcomed')){
      w.classList.add('show');
      setTimeout(()=>{ w.classList.remove('show'); w.classList.add('hide'); },1000);
      localStorage.setItem('lynka_welcomed','1');
    }else{ w.remove(); }
  }

  /* ===== Auth (Fullscreen) ===== */
  $('#loginBtn').onclick = async()=>{
    $('#authErr').textContent='';
    try{
      await auth.signInWithEmailAndPassword($('#email').value.trim(), $('#pass').value.trim());
    }catch(e){ $('#authErr').textContent='Firebase: '+(e.message||'خطأ'); }
  };
  $('#logoutBtn').onclick = ()=>auth.signOut();

  auth.onAuthStateChanged(u=>{
    if(u){
      // إظهار التطبيق، إخفاء شاشة الدخول
      hide($('#auth')); show($('#app'));
      $('#userMail').textContent=u.email; show($('#userMail')); show($('#logoutBtn'));
      welcomeOnce();
      initApp();  // ربط المستمعين بعد الدخول فقط
      // افتح آخر تاب كان محفوظ أو المنتجات
      showSec(sessionStorage.getItem('lynka_tab') || 'products');
    }else{
      // إظهار شاشة الدخول وإخفاء التطبيق
      show($('#auth')); hide($('#app'));
      hide($('#userMail')); hide($('#logoutBtn'));
    }
  });

  /* ===== Collections ===== */
  const col = {
    products: db.collection('products'),
    orders:   db.collection('orders'),
    expenses: db.collection('expenses'),
    revenues: db.collection('revenues'),
    clients:  db.collection('clients'),
  };

  /* ===================== PRODUCTS ===================== */
  let allProducts = []; // لتوليد حساب الموزعين
  $('#addProduct').onclick = async()=>{
    const name = $('#pName').value.trim();
    const factory = parseFloat(($('#pFactory').value||'').toString().replace(',','.'));
    const qty     = parseInt($('#pQty').value||'0',10);
    const unit    = $('#pUnit').value;
    if(!name || isNaN(factory) || isNaN(qty)) return;

    const dname  = $('#pDistName').value.trim();
    const dprice = parseFloat(($('#pDistPrice').value||'').toString().replace(',','.'));
    const distributors = {};
    if(dname && !isNaN(dprice)) distributors[dname]=dprice;

    await col.products.add({
      name, factory, qty, unit, distributors,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    ['#pName','#pFactory','#pQty','#pDistName','#pDistPrice'].forEach(s=>$(s).value='');
  };

  function productCard(id,d){
    const el = document.createElement('div'); el.className='card';
    el.innerHTML = `
      <div class="row" style="align-items:center">
        <div class="title" style="flex:1">${d.name} <span class="muted">(${d.unit||'Unit'})</span></div>
        <button class="ghost" data-act="save" style="flex:0 0 auto">حفظ</button>
        <button class="danger" data-act="del" style="flex:0 0 auto">حذف المنتج</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input type="number" step="0.01" value="${d.factory??0}" data-f="factory" placeholder="سعر المصنع">
        <input type="number" step="1"   value="${d.qty??0}"     data-f="qty"     placeholder="الكمية">
        <div class="card" style="flex:1">
          <div class="title" style="margin-bottom:8px">الموزّعون</div>
          <div class="list" data-dists></div>
          <div class="row" style="margin-top:8px">
            <input placeholder="اسم موزّع" data-add-name>
            <input type="number" step="0.01" placeholder="سعر" data-add-price>
            <button class="btn" style="--c:var(--t-products)" data-act="addDist">إضافة</button>
          </div>
        </div>
      </div>`;
    const wrap = el.querySelector('[data-dists]'); wrap.innerHTML='';
    Object.entries(d.distributors||{}).forEach(([name,price])=>{
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <input value="${name}" data-n style="flex:1">
        <input type="number" step="0.01" value="${price}" data-p style="flex:1">
        <button class="ghost" data-act="upd">تحديث</button>
        <button class="danger" data-act="rm">حذف</button>`;
      row.querySelector('[data-act="upd"]').onclick = async()=>{
        const n = row.querySelector('[data-n]').value.trim();
        const p = parseFloat((row.querySelector('[data-p]').value||'').toString().replace(',','.'));
        if(!n || isNaN(p)) return;
        const map = {...(d.distributors||{})}; delete map[name]; map[n]=p;
        await col.products.doc(id).update({distributors:map});
      };
      row.querySelector('[data-act="rm"]').onclick = async()=>{
        const map = {...(d.distributors||{})}; delete map[name];
        await col.products.doc(id).update({distributors:map});
      };
      wrap.appendChild(row);
    });

    el.querySelector('[data-act="addDist"]').onclick = async()=>{
      const n = el.querySelector('[data-add-name]').value.trim();
      const p = parseFloat((el.querySelector('[data-add-price]').value||'').toString().replace(',','.'));
      if(!n || isNaN(p)) return;
      const map = {...(d.distributors||{})}; map[n]=p;
      await col.products.doc(id).update({distributors:map});
      el.querySelector('[data-add-name]').value=''; el.querySelector('[data-add-price]').value='';
    };
    el.querySelector('[data-act="save"]').onclick = async()=>{
      const factory = parseFloat((el.querySelector('[data-f="factory"]').value||'').toString().replace(',','.'));
      const qty     = parseInt(el.querySelector('[data-f="qty"]').value||'0',10);
      if(isNaN(factory)||isNaN(qty)) return;
      await col.products.doc(id).update({factory,qty});
    };
    el.querySelector('[data-act="del"]').onclick = ()=>col.products.doc(id).delete();
    return el;
  }

  function watchProducts(){
    col.products.orderBy('createdAt','desc').onSnapshot(snap=>{
      allProducts = []; const set = new Set(); const list = $('#productsList'); list.innerHTML='';
      snap.forEach(doc=>{
        const d = doc.data(); allProducts.push({id:doc.id, ...d});
        Object.keys(d.distributors||{}).forEach(k=>set.add(k));
        list.appendChild(productCard(doc.id,d));
      });
      // تعبئة الموزعين للحساب
      const sel = $('#distSelect'); const current = sel.value;
      sel.innerHTML = [...set].sort().map(n=>`<option value="${n}">${n}</option>`).join('');
      if([...set].includes(current)) sel.value=current;
      renderCalc();
    });
  }

  /* ===================== CALC ===================== */
  function renderCalc(){
    const dist = $('#distSelect').value;
    const L = $('#calcList'); L.innerHTML='';
    let tf=0, td=0;
    allProducts.forEach(p=>{
      const priceD = (p.distributors||{})[dist];
      if(priceD==null) return;
      const f = (Number(p.factory)||0) * (Number(p.qty)||0);
      const d = (Number(priceD)||0)    * (Number(p.qty)||0);
      tf += f; td += d;
      const row = document.createElement('div'); row.className='item';
      row.innerHTML = `
        <div style="flex:1">
          <div class="title">${p.name}</div>
          <div class="muted">Qty: ${en(p.qty)} — Factory: ${en(p.factory)} — Dist: ${en(priceD)}</div>
        </div>
        <div class="price-big">${en(d)}</div>`;
      L.appendChild(row);
    });
    $('#totFactory').textContent = en(tf);
    $('#totDist').textContent    = en(td);
    $('#totDiff').textContent    = en(td - tf);
  }
  $('#distSelect').addEventListener('change', renderCalc);

  /* ===================== ORDERS ===================== */
  $('#addOrder').onclick = async()=>{
    const client=$('#oClient').value.trim();
    const title =$('#oTitle').value.trim();
    const amount=parseFloat(($('#oAmount').value||'').toString().replace(',','.'))||0;
    await col.orders.add({
      client,title,amount,status:$('#oStatus').value,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    ['#oClient','#oTitle','#oAmount'].forEach(s=>$(s).value='');
  };
  function watchOrders(){
    col.orders.orderBy('createdAt','desc').onSnapshot(snap=>{
      const L=$('#ordersList'); L.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data();
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`
          <div style="flex:1">
            <div class="title">${d.title||'طلب'}</div>
            <div class="muted">عميل: ${d.client||'-'} • حالة: ${d.status} • إجمالي: ${en(d.amount)}</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <button class="ghost" data-act="done">تم</button>
            <button class="danger" data-act="del">حذف</button>
          </div>`;
        el.querySelector('[data-act="done"]').onclick=()=>col.orders.doc(doc.id).update({status:'تم'});
        el.querySelector('[data-act="del"]').onclick=()=>col.orders.doc(doc.id).delete();
        L.appendChild(el);
      });
    });
  }

  /* ===================== FINANCE ===================== */
  $('#addExpense').onclick=async()=>{
    const cat=$('#exCat').value.trim(); const amount=parseFloat(($('#exAmount').value||'').toString().replace(',','.'));
    if(isNaN(amount)) return;
    await col.expenses.add({category:cat,amount,note:$('#exNote').value.trim(),date:firebase.firestore.FieldValue.serverTimestamp()});
    ['#exCat','#exAmount','#exNote'].forEach(s=>$(s).value='');
  };
  $('#addRevenue').onclick=async()=>{
    const cat=$('#revCat').value.trim(); const amount=parseFloat(($('#revAmount').value||'').toString().replace(',','.'));
    if(isNaN(amount)) return;
    await col.revenues.add({category:cat,amount,note:$('#revNote').value.trim(),date:firebase.firestore.FieldValue.serverTimestamp()});
    ['#revCat','#revAmount','#revNote'].forEach(s=>$(s).value='');
  };
  function financeRow(d, del){
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="flex:1"><div class="title">${d.category||'-'}</div><div class="muted">${d.note||''}</div></div>
                    <div class="price-big">${en(d.amount)}</div>
                    <button class="danger">حذف</button>`;
    el.querySelector('button').onclick=del; return el;
  }
  function watchExpenses(){
    col.expenses.orderBy('date','desc').onSnapshot(snap=>{
      const L=$('#expList'); L.innerHTML=''; let sum=0;
      snap.forEach(doc=>{ const d=doc.data(); sum+=Number(d.amount)||0; L.appendChild(financeRow(d,()=>col.expenses.doc(doc.id).delete())); });
      $('#sumExp').textContent=en(sum); updateNet();
    });
  }
  function watchRevenues(){
    col.revenues.orderBy('date','desc').onSnapshot(snap=>{
      const L=$('#revList'); L.innerHTML=''; let sum=0;
      snap.forEach(doc=>{ const d=doc.data(); sum+=Number(d.amount)||0; L.appendChild(financeRow(d,()=>col.revenues.doc(doc.id).delete())); });
      $('#sumRev').textContent=en(sum); updateNet();
    });
  }
  function updateNet(){
    const rev = Number(($('#sumRev').textContent||'0').replace(/,/g,''))||0;
    const exp = Number(($('#sumExp').textContent||'0').replace(/,/g,''))||0;
    $('#netTotal').textContent = en(rev-exp);
  }

  /* ===================== CLIENTS ===================== */
  $('#addClient').onclick=async()=>{
    const name=$('#cName').value.trim(); if(!name) return;
    await col.clients.add({
      name, phone:$('#cPhone').value.trim(), email:$('#cEmail').value.trim(),
      address:$('#cAddress').value.trim(), note:$('#cNote').value.trim(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    ['#cName','#cPhone','#cEmail','#cAddress','#cNote'].forEach(s=>$(s).value='');
  };
  function watchClients(){
    col.clients.orderBy('createdAt','desc').onSnapshot(snap=>{
      const L=$('#clientsList'); L.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data();
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<div style="flex:1">
                        <div class="title">${d.name}</div>
                        <div class="muted">${d.phone||''} • ${d.email||''} • ${d.address||''}</div>
                        <div class="muted">${d.note||''}</div>
                      </div>
                      <button class="danger">حذف</button>`;
        el.querySelector('button').onclick=()=>col.clients.doc(doc.id).delete();
        L.appendChild(el);
      });
    });
  }

  /* ===== Init listeners بعد تسجيل الدخول فقط ===== */
  let initialized = false;
  function initApp(){
    if(initialized) return;
    watchProducts();  watchOrders();
    watchExpenses();  watchRevenues();
    watchClients();
    initialized = true;
  }
</script>
</body>
</html>
