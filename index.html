<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lynka â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f8ff; --ink:#0b1220; --muted:#6b7280;
      --tabbar:#171a1f; --brand:#2563eb; --ok:#10b981; --danger:#ef4444;
      --card:#ffffff; --line:#e5e7eb;
      --soft-blue:#f0f6ff; --soft-green:#ecfff2;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto;
      font-size:15px;line-height:1.6;}
    .wrap{max-width:1140px;margin:auto;padding:12px}

    .topbar{display:flex;justify-content:space-between;align-items:center;
      margin-bottom:12px;gap:10px;flex-wrap:wrap}
    .title{font-weight:800;font-size:20px}
    .user-pill{padding:8px 14px;border-radius:12px;
      background:linear-gradient(135deg,#4f46e5,#06b6d4);
      color:#fff;font-weight:700;cursor:pointer;font-size:14px}

    .nav-tabs{display:flex;overflow-x:auto;gap:6px;background:var(--tabbar);
      padding:6px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.15)}
    .nav-tab{flex:0 0 auto;border:0;cursor:pointer;
      padding:10px 16px;border-radius:10px;
      background:transparent;color:#f1f5f9;font-weight:700;font-size:14px}
    .nav-tab.active{background:#fff;color:var(--ink);box-shadow:inset 0 0 0 2px #e6e9f2}

    section{background:var(--card);margin-top:12px;padding:16px;border-radius:14px;
      box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .hide{display:none !important}

    .card{background:var(--card);border:1px solid var(--line);
      border-radius:12px;padding:14px;margin-bottom:14px}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:768px){
      .grid.two,.grid.three{grid-template-columns:1fr}
      .nav-tab{font-size:13px;padding:8px 12px}
      .title{font-size:18px}
    }

    input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);
      border-radius:10px;font-size:14px;background:#fff}
    input::placeholder{color:#94a3b8}
    textarea{min-height:84px;resize:vertical}

    .btn{padding:10px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px}
    .btn.brand{background:var(--brand);color:#fff}
    .btn.ok{background:var(--ok);color:#fff}
    .btn.red{background:var(--danger);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1e293b}

    /* Tasks */
    .task{display:flex;gap:10px;align-items:flex-start;
      background:var(--soft-blue);padding:12px;border-radius:12px;flex-wrap:wrap}
    .task-done{background:var(--soft-green)}
    .task .txt{flex:1;line-height:1.8}

    /* Products */
    .prod-card{border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .prod-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .dist-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}

    /* Table (calc) */
    .table-wrap{overflow-x:auto}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    table thead{background:#f8fafc}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center;font-size:14px;white-space:nowrap}

    /* Toast */
    .toast{position:fixed;inset-inline:0;top:14px;margin:auto;max-width:90%;
      background:#0f172a;color:#fff;padding:12px 14px;border-radius:12px;
      display:flex;justify-content:center;align-items:center;gap:10px;
      transform:translateY(-30px);opacity:0;pointer-events:none;
      transition:all .35s ease;z-index:9999;font-size:14px}
    .toast.show{transform:translateY(0);opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="topbar">
    <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” <b>Lynka</b></div>
    <div class="user-pill" id="userPill" title="Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"><span id="userEmail">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span></div>
  </div>

  <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <div class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-s="tasks">ğŸ“ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button class="nav-tab" data-s="products">ğŸ·ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button class="nav-tab" data-s="calc">ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    <button class="nav-tab" data-s="orders">ğŸ§¾ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</button>
    <button class="nav-tab" data-s="finance">ğŸ’¹ Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ£Ø±Ø¨Ø§Ø­</button>
    <button class="nav-tab" data-s="clients">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    <button class="nav-tab" data-s="inventory">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
    <button class="nav-tab" data-s="auth">ğŸ” Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="s-auth" class="hide">
    <div class="card grid">
      <h2 style="margin:0 0 6px">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Lynka</h2>
      <div class="grid two">
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="inEmail" type="email" placeholder="1@lynka.com Ø£Ùˆ 2@lynka.com">
        </div>
        <div>
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="inPass" type="password" placeholder="87654321">
        </div>
      </div>
      <div class="row" style="display:flex;gap:10px;align-items:center">
        <button class="btn brand" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
        <div id="authErr" class="muted" style="color:#ef4444"></div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
  <section id="s-tasks">
    <div class="grid two">
      <div class="card">
        <h3 style="margin-top:0">Ø£Ø¶Ù Ù…Ù‡Ù…Ø©</h3>
        <div class="grid">
          <textarea id="taskText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© (ÙŠØ³Ù…Ø­ Ø¨Ù†Øµ Ø·ÙˆÙŠÙ„)â€¦"></textarea>
          <input id="taskTag" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <div class="row">
            <button class="btn brand" id="addTask">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙÙ†Ø¬Ø²Ø©</h3>
          <div class="muted">Ø¹Ø¯Ø¯: <span id="doneCount">0</span></div>
        </div>
        <div class="list" id="doneList"></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø·Ø©</h3>
        <div class="muted">Ø¹Ø¯Ø¯: <span id="activeCount">0</span></div>
      </div>
      <div class="list" id="tasksList"></div>
    </div>
  </section>

  <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <section id="s-products" class="hide">
    <div class="card">
      <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
      <div class="grid three">
        <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="pFactory" type="number" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹">
        <input id="pQty" type="number" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
      </div>
      <div class="grid two" style="margin-top:8px">
        <input id="pDistName" placeholder="Ø§Ø³Ù… Ù…ÙˆØ²Ù‘Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <input id="pDistPrice" type="number" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn brand" id="addProduct">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
      </div>
    </div>

    <div id="productsList" class="grid"></div>
  </section>

  <!-- Ø§Ù„Ø­Ø³Ø§Ø¨ -->
  <section id="s-calc" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap">
        <h3 style="margin:0">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</h3>
        <div class="row">
          <label class="muted">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹:</label>
          <select id="distSelect"></select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµÙ†Ø¹</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹</th>
            </tr>
          </thead>
          <tbody id="calcTable"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:center;margin-top:12px;gap:20px;font-weight:800">
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµÙ†Ø¹: <span id="totFactory">0</span></div>
        <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ²Ù‘Ø¹: <span id="totDist">0</span></div>
        <div>Ø§Ù„ÙØ±Ù‚ (Ø§Ù„Ø±Ø¨Ø­): <span id="totDiff">0</span></div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª -->
  <section id="s-orders" class="hide">
    <div class="card">
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø±</h3>
      <div class="grid two">
        <input id="oClient" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input id="oAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn brand" id="addOrder">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</h3>
        <div class="row"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: </b>&nbsp;<span id="sumOrders">0</span></div>
      </div>
      <div id="ordersList" class="list"></div>
    </div>
  </section>

  <!-- Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
  <section id="s-finance" class="hide">
    <div class="grid two">
      <div class="card">
        <h3 style="margin:0">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
        <div class="grid two">
          <input id="exDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <input id="exAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn red" id="addExpense">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="expList" class="list" style="margin-top:8px"></div>
        <div class="card" style="margin-top:8px"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: </b><span id="sumExp">0</span></div>
      </div>

      <div class="card">
        <h3 style="margin:0">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
        <div class="grid two">
          <input id="prDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
          <input id="prAmount" type="number" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" id="addProfit">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="proList" class="list" style="margin-top:8px"></div>
        <div class="card" style="margin-top:8px"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: </b><span id="sumPro">0</span></div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <section id="s-clients" class="hide">
    <div class="card">
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</h3>
      <div class="grid two">
        <input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input id="cPhone" placeholder="Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn brand" id="addClient">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
      <div id="clientsList" class="list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
  <section id="s-inventory" class="hide">
    <div class="card">
      <h3 style="margin:0">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù…Ø®Ø²ÙˆÙ†</h3>
      <div class="grid three">
        <input id="iName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="iQty" type="number" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input id="iMin" type="number" step="1" placeholder="Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn brand" id="addInv">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>
    <div class="card">
      <h3 style="margin:0">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
      <div id="invList" class="list" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØ©) -->
<div id="welcomeToast" class="toast">ğŸ‘‹ Welcome <b>Steven</b> and <b>Nassef</b></div>

<!-- Firebase v12 (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  /* ===== Firebase Config (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù„ÙŠ Ø§Ø´ØªØºÙ„Øª Ù…Ø¹Ø§Ùƒ) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCnM6-7BoICLWAXUeH8qz8A_OCiCGpQtMU",
    authDomain: "lynka-to-do-list-eb2ac.firebaseapp.com",
    projectId: "lynka-to-do-list-eb2ac",
    storageBucket: "lynka-to-do-list-eb2ac.firebasestorage.app",
    messagingSenderId: "202285237255",
    appId: "1:202285237255:web:c12e66369d033e4ecd96a2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  /* ===== Helpers ===== */
  const $  = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const en = n => (Number(n||0)).toLocaleString('en-US',{maximumFractionDigits:2});
  const escapeHtml = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;" }[m]));

  // Toast ØªØ±Ø­ÙŠØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
  const toast = $('#welcomeToast');
  function welcomeOnce(){
    if(!localStorage.getItem('lynka_welcomed')){
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1000);
      setTimeout(()=>toast.remove(),1600);
      localStorage.setItem('lynka_welcomed','1');
    } else { toast.remove(); }
  }

  // Tabs
  const tabs = $$('#navTabs .nav-tab');
  const sections = $$('section[id^="s-"]');
  function showSection(key){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.s===key));
    sections.forEach(s=>s.classList.toggle('hide', s.id!=='s-'+key));
    sessionStorage.setItem('lynka_tab', key);
  }
  tabs.forEach(t=>t.addEventListener('click',()=>showSection(t.dataset.s)));
  showSection(sessionStorage.getItem('lynka_tab') || 'tasks');

  // Auth
  const userPill = $('#userPill'); const userEmail = $('#userEmail');
  $('#btnLogin')?.addEventListener('click', async ()=>{
    const email=$('#inEmail').value.trim();
    const pass =$('#inPass').value.trim();
    $('#authErr').textContent='';
    try{ await signInWithEmailAndPassword(auth,email,pass); }
    catch(e){ $('#authErr').textContent='Ø®Ø·Ø£: '+(e.code||e.message); }
  });
  userPill.addEventListener('click', async ()=>{ if(auth.currentUser) await signOut(auth); });

  onAuthStateChanged(auth, u=>{
    if(u){
      $('#s-auth').classList.add('hide');
      userEmail.textContent = u.email;
      welcomeOnce();
      showSection(sessionStorage.getItem('lynka_tab') || 'tasks');
    }else{
      $('#s-auth').classList.remove('hide');
      userEmail.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      showSection('auth');
    }
  });

  /* ===== Collections ===== */
  const colTasks   = collection(db,'lynka_tasks');
  const colProds   = collection(db,'lynka_products');
  const colOrders  = collection(db,'lynka_orders');
  const colExp     = collection(db,'lynka_expenses');
  const colPro     = collection(db,'lynka_profits');
  const colClients = collection(db,'lynka_clients');
  const colInv     = collection(db,'lynka_inventory');

  /* ===== Tasks ===== */
  $('#addTask').addEventListener('click', async ()=>{
    const text = $('#taskText').value.trim();
    const tag  = $('#taskTag').value.trim() || null;
    if(!text) return;
    await addDoc(colTasks,{text,tag,done:false,createdAt:serverTimestamp()});
    $('#taskText').value=''; $('#taskTag').value='';
  });
  function taskItem(id,d){
    const el = document.createElement('div');
    el.className = 'task'+(d.done?' task-done':'');
    el.innerHTML = `
      <input type="checkbox" ${d.done?'checked':''} />
      <div class="txt"><div>${escapeHtml(d.text)}</div><small class="muted">${d.tag?('#'+escapeHtml(d.tag)):'â€”'}</small></div>
      <button class="btn red">Ø­Ø°Ù</button>`;
    el.querySelector('input').addEventListener('change',()=>updateDoc(doc(db,'lynka_tasks',id),{done:!d.done}));
    el.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_tasks',id)));
    return el;
  }
  onSnapshot(query(colTasks,orderBy('createdAt','desc')),(snap)=>{
    const tasksList=$('#tasksList'), doneList=$('#doneList');
    tasksList.innerHTML=''; doneList.innerHTML='';
    let a=0, d=0;
    snap.forEach(s=>{
      const data=s.data(); const el=taskItem(s.id,data);
      if(data.done){ d++; doneList.appendChild(el); } else { a++; tasksList.appendChild(el); }
    });
    $('#activeCount').textContent=a; $('#doneCount').textContent=d;
  });

  /* ===== Products (name, factory, qty, distributors{ name:price }) ===== */
  $('#addProduct').addEventListener('click', async ()=>{
    const name = $('#pName').value.trim();
    const factory = parseFloat(($('#pFactory').value||'').toString().replace(',','.'));
    const qty = parseInt($('#pQty').value||'0',10);
    const dname = $('#pDistName').value.trim();
    const dprice = parseFloat(($('#pDistPrice').value||'').toString().replace(',','.'));
    if(!name || isNaN(factory) || !qty) return;
    const distributors = {};
    if(dname && !isNaN(dprice)) distributors[dname]=dprice;
    await addDoc(colProds,{name, factory, qty, distributors, createdAt:serverTimestamp()});
    ['#pName','#pFactory','#pQty','#pDistName','#pDistPrice'].forEach(s=>$(s).value='');
  });

  function productCard(id,d){
    const card = document.createElement('div'); card.className='prod-card';
    card.innerHTML = `
      <div class="prod-head">
        <div class="big">${escapeHtml(d.name)}</div>
        <div class="row">
          <button class="btn ghost" data-act="save">Ø­ÙØ¸</button>
          <button class="btn red" data-act="del">Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
      </div>
      <div class="grid three">
        <div><label class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹</label><input type="number" step="0.01" value="${d.factory??0}" data-f="factory"></div>
        <div><label class="muted">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" step="1" value="${d.qty??0}" data-f="qty"></div>
        <div><label class="muted">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ²Ù‘Ø¹</label><div class="row"><input placeholder="Ø§Ø³Ù…" data-add-name><input type="number" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø±" data-add-price><button class="btn brand" data-act="addDist">Ø¥Ø¶Ø§ÙØ©</button></div></div>
      </div>
      <div><label class="muted">Ù…ÙˆØ²Ù‘Ø¹ÙŠÙ†</label><div class="list" data-dists></div></div>
    `;
    // render distributors
    const distsWrap = card.querySelector('[data-dists]'); distsWrap.innerHTML='';
    Object.entries(d.distributors||{}).forEach(([name,price])=>{
      const row = document.createElement('div'); row.className='dist-row';
      row.innerHTML = `
        <input value="${escapeHtml(name)}" data-dn>
        <input type="number" step="0.01" value="${price}" data-dp>
        <div class="row">
          <button class="btn ghost" data-act="updDist">ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn red" data-act="delDist">Ø­Ø°Ù</button>
        </div>`;
      row.querySelector('[data-act="updDist"]').addEventListener('click', async ()=>{
        const newName = row.querySelector('[data-dn]').value.trim();
        const newPrice= parseFloat((row.querySelector('[data-dp]').value||'').toString().replace(',','.'));
        if(!newName || isNaN(newPrice)) return;
        const newMap = {...(d.distributors||{})};
        delete newMap[name]; newMap[newName]=newPrice;
        await updateDoc(doc(db,'lynka_products',id),{distributors:newMap});
      });
      row.querySelector('[data-act="delDist"]').addEventListener('click', async ()=>{
        const newMap = {...(d.distributors||{})};
        delete newMap[name];
        await updateDoc(doc(db,'lynka_products',id),{distributors:newMap});
      });
      distsWrap.appendChild(row);
    });

    // Add distributor
    card.querySelector('[data-act="addDist"]').addEventListener('click', async ()=>{
      const n = card.querySelector('[data-add-name]').value.trim();
      const p = parseFloat((card.querySelector('[data-add-price]').value||'').toString().replace(',','.'));
      if(!n || isNaN(p)) return;
      const newMap = {...(d.distributors||{})}; newMap[n]=p;
      await updateDoc(doc(db,'lynka_products',id),{distributors:newMap});
      card.querySelector('[data-add-name]').value=''; card.querySelector('[data-add-price]').value='';
    });

    // Save factory/qty
    card.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
      const factory = parseFloat((card.querySelector('[data-f="factory"]').value||'').toString().replace(',','.'));
      const qty     = parseInt(card.querySelector('[data-f="qty"]').value||'0',10);
      if(isNaN(factory) || isNaN(qty)) return;
      await updateDoc(doc(db,'lynka_products',id),{factory,qty});
    });

    // delete product
    card.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
      await deleteDoc(doc(db,'lynka_products',id));
    });

    return card;
  }

  let allProducts = []; // Ù„ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ† ÙˆØ§Ù„Ø­Ø³Ø§Ø¨
  onSnapshot(query(colProds,orderBy('createdAt','desc')),(snap)=>{
    allProducts = [];
    const wrap = $('#productsList'); wrap.innerHTML='';
    const distSet = new Set();
    snap.forEach(s=>{
      const data = s.data(); allProducts.push({id:s.id, ...data});
      Object.keys(data.distributors||{}).forEach(k=>distSet.add(k));
      wrap.appendChild(productCard(s.id,data));
    });
    // Ù…Ù„Ø£ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ²Ø¹ÙŠÙ†
    const sel = $('#distSelect');
    const current = sel.value;
    sel.innerHTML = [...distSet].sort().map(n=>`<option value="${n}">${n}</option>`).join('');
    if([...distSet].includes(current)) sel.value=current;
    renderCalc();
  });

  /* ===== Calc ===== */
  function renderCalc(){
    const dist = $('#distSelect').value;
    const body = $('#calcTable'); body.innerHTML='';
    let totF=0, totD=0;
    allProducts.forEach(p=>{
      const priceD = (p.distributors||{})[dist];
      if(priceD==null) return;
      const f = (Number(p.factory)||0) * (Number(p.qty)||0);
      const d = (Number(priceD)||0)    * (Number(p.qty)||0);
      totF += f; totD += d;
      body.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${escapeHtml(p.name)}</td>
          <td>${en(p.factory)}</td>
          <td>${en(p.qty)}</td>
          <td>${en(priceD)}</td>
          <td>${en(f)}</td>
          <td>${en(d)}</td>
        </tr>`);
    });
    $('#totFactory').textContent = en(totF);
    $('#totDist').textContent    = en(totD);
    $('#totDiff').textContent    = en(totD - totF);
  }
  $('#distSelect').addEventListener('change', renderCalc);

  /* ===== Orders ===== */
  $('#addOrder').addEventListener('click', async ()=>{
    const client=$('#oClient').value.trim();
    const amount=parseFloat(($('#oAmount').value||'').toString().replace(',','.'));
    if(!client || isNaN(amount)) return;
    await addDoc(colOrders,{client,amount,createdAt:serverTimestamp()});
    $('#oClient').value=''; $('#oAmount').value='';
  });
  onSnapshot(query(colOrders,orderBy('createdAt','desc')),(snap)=>{
    const L=$('#ordersList'); L.innerHTML=''; let sum=0;
    snap.forEach(s=>{
      const d=s.data(); sum+=Number(d.amount)||0;
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML = `<div class="big">${escapeHtml(d.client)}</div>
                       <div class="big">${en(d.amount)}</div>
                       <button class="btn red">Ø­Ø°Ù</button>`;
      row.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_orders',s.id)));
      L.appendChild(row);
    });
    $('#sumOrders').textContent=en(sum);
  });

  /* ===== Finance ===== */
  $('#addExpense').addEventListener('click', async ()=>{
    const desc=$('#exDesc').value.trim()||null;
    const amount=parseFloat(($('#exAmount').value||'').toString().replace(',','.'));
    if(isNaN(amount)) return;
    await addDoc(colExp,{desc,amount,createdAt:serverTimestamp()});
    $('#exDesc').value=''; $('#exAmount').value='';
  });
  $('#addProfit').addEventListener('click', async ()=>{
    const desc=$('#prDesc').value.trim()||null;
    const amount=parseFloat(($('#prAmount').value||'').toString().replace(',','.'));
    if(isNaN(amount)) return;
    await addDoc(colPro,{desc,amount,createdAt:serverTimestamp()});
    $('#prDesc').value=''; $('#prAmount').value='';
  });
  onSnapshot(query(colExp,orderBy('createdAt','desc')),(snap)=>{
    const L=$('#expList'); L.innerHTML=''; let sum=0;
    snap.forEach(s=>{
      const d=s.data(); sum+=Number(d.amount)||0;
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML = `<div>${d.desc?escapeHtml(d.desc):'<span class="muted">Ø¨Ø¯ÙˆÙ† ÙˆØµÙ</span>'}</div>
                       <div class="big">${en(d.amount)}</div>
                       <button class="btn red">Ø­Ø°Ù</button>`;
      row.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_expenses',s.id)));
      L.appendChild(row);
    });
    $('#sumExp').textContent=en(sum);
  });
  onSnapshot(query(colPro,orderBy('createdAt','desc')),(snap)=>{
    const L=$('#proList'); L.innerHTML=''; let sum=0;
    snap.forEach(s=>{
      const d=s.data(); sum+=Number(d.amount)||0;
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML = `<div>${d.desc?escapeHtml(d.desc):'<span class="muted">Ø¨Ø¯ÙˆÙ† ÙˆØµÙ</span>'}</div>
                       <div class="big">${en(d.amount)}</div>
                       <button class="btn red">Ø­Ø°Ù</button>`;
      row.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_profits',s.id)));
      L.appendChild(row);
    });
    $('#sumPro').textContent=en(sum);
  });

  /* ===== Clients ===== */
  $('#addClient').addEventListener('click', async ()=>{
    const name=$('#cName').value.trim(); const phone=$('#cPhone').value.trim()||null;
    if(!name) return;
    await addDoc(colClients,{name,phone,createdAt:serverTimestamp()});
    $('#cName').value=''; $('#cPhone').value='';
  });
  onSnapshot(query(colClients,orderBy('createdAt','desc')),(snap)=>{
    const L=$('#clientsList'); L.innerHTML='';
    snap.forEach(s=>{
      const d=s.data();
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML = `<div class="big">${escapeHtml(d.name)}</div>
                       <div>${d.phone?escapeHtml(d.phone):'<span class="muted">â€”</span>'}</div>
                       <button class="btn red">Ø­Ø°Ù</button>`;
      row.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_clients',s.id)));
      L.appendChild(row);
    });
  });

  /* ===== Inventory ===== */
  $('#addInv').addEventListener('click', async ()=>{
    const name=$('#iName').value.trim(); const qty=parseInt($('#iQty').value||'0',10);
    const min=parseInt($('#iMin').value||'0',10);
    if(!name || isNaN(qty)) return;
    await addDoc(colInv,{name,qty,min:(isNaN(min)?0:min),createdAt:serverTimestamp()});
    ['#iName','#iQty','#iMin'].forEach(s=>$(s).value='');
  });
  onSnapshot(query(colInv,orderBy('createdAt','desc')),(snap)=>{
    const L=$('#invList'); L.innerHTML='';
    snap.forEach(s=>{
      const d=s.data(); const low=(Number(d.qty)||0) <= (Number(d.min)||0);
      const row=document.createElement('div'); row.className='card row';
      row.innerHTML = `<div class="big">${escapeHtml(d.name)} ${low?'<span class="muted" style="color:#b91c1c">â€¢ Ù…Ù†Ø®ÙØ¶</span>':''}</div>
                       <div class="big">${en(d.qty)}</div>
                       <button class="btn ghost" data-act="inc">+1</button>
                       <button class="btn ghost" data-act="dec">-1</button>
                       <button class="btn red">Ø­Ø°Ù</button>`;
      row.querySelector('[data-act="inc"]').addEventListener('click',()=>updateDoc(doc(db,'lynka_inventory',s.id),{qty:(Number(d.qty)||0)+1}));
      row.querySelector('[data-act="dec"]').addEventListener('click',()=>updateDoc(doc(db,'lynka_inventory',s.id),{qty:Math.max(0,(Number(d.qty)||0)-1)}));
      row.querySelector('.btn.red').addEventListener('click',()=>deleteDoc(doc(db,'lynka_inventory',s.id)));
      L.appendChild(row);
    });
  });
</script>
</body>
</html>
